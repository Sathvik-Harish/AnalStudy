<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnalStudy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        .app-container {
            width: 100%;
            max-width: 400px; /* Average smartphone width */
            height: 100vh; /* Full viewport height */
            max-height: 800px; /* Average smartphone height */
            background-color: #2d3748; /* Slightly lighter dark background for the app */
            border-radius: 1.5rem; /* Rounded corners */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Hide scrollbars for internal content */
            position: relative;
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            padding: 1.5rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .screen.active {
            display: flex;
        }
        input, button, select, textarea {
            border-radius: 0.75rem; /* Rounded corners for inputs/buttons */
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            font-size: 1rem;
            color: #e2e8f0;
            background-color: #4a5568; /* Darker input background */
            border: 1px solid #4a5568;
            outline: none;
            transition: all 0.2s ease-in-out;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #63b3ed; /* Blue focus border */
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.5);
        }
        button {
            cursor: pointer;
            background-color: #4299e1; /* Blue button */
            font-weight: 600;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background-color: #3182ce; /* Darker blue on hover */
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .delete-button {
            background-color: #e53e3e; /* Red for delete */
        }
        .delete-button:hover {
            background-color: #c53030;
        }
        .edit-button {
            background-color: #48bb78; /* Green for edit */
        }
        .edit-button:hover {
            background-color: #38a169;
        }
        .give-up-button, .archive-button {
            background-color: #a0aec0;
        }
        .give-up-button:hover, .archive-button:hover {
            background-color: #718096;
        }
        .do-later-button {
            background-color: #ecc94b;
        }
        .do-later-button:hover {
            background-color: #d69e2e;
        }
        .subject-item, .task-item, .goal-item, .session-item, .update-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #4a5568;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .task-item.completed, .goal-item.completed {
            background-color: #38a169;
            color: #fff;
        }
        .task-item.given-up, .task-item.do-later, .goal-item.archived {
            background-color: #718096;
        }
        .session-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .session-item:hover {
            background-color: #5a677b;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background-color: #2d3748;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        .modal-content h2 {
            color: #63b3ed;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .modal-content button {
            margin-top: 1rem;
            margin-left: 0.5rem;
            margin-right: 0.5rem;
        }
        .timer-display {
            font-size: 4rem;
            font-weight: 700;
            text-align: center;
            margin: 2rem 0;
            color: #4299e1;
            letter-spacing: 2px;
        }
        .progress-bar-container {
            width: 100%;
            height: 24px;
            background-color: #4a5568;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 100%;
            background-color: #48bb78; /* Green for study time */
            transition: width 0.5s ease-in-out;
        }
        .idle-bar {
            height: 100%;
            background-color: #e53e3e; /* Red for idle time */
            position: absolute;
            top: 0;
            right: 0;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Main Menu Screen -->
        <div id="mainMenuScreen" class="screen active">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">AnalStudy</h1>
            <p class="text-center text-gray-400 mb-6">Select an option below.</p>

            <button id="startNewSessionButton" class="w-full mb-4">Start New Session</button>
            <button id="showTasksButton" class="w-full mb-4">View Tasks</button>
            <button id="showGoalsButton" class="w-full mb-4">Manage Goals</button>
            <button id="showGraphsButton" class="w-full mb-4">Graphs & Analysis</button>
            <button id="showSessionsButton" class="w-full mb-4">View Past Sessions</button>
            <button id="showMoreButton" class="w-full mb-4 bg-gray-600 hover:bg-gray-700">More</button>
        </div>

        <!-- More Screen -->
        <div id="moreScreen" class="screen">
            <h2 class="text-2xl font-bold mb-4 text-blue-300">More Options</h2>
            <button id="showUpdatesButton" class="w-full mb-4">Updates</button>
            <button id="showSettingsButton" class="w-full mb-4">Settings</button>
            <button id="showPrivacyButton" class="w-full mb-4">Privacy Policy</button>
            <button id="showTermsButton" class="w-full mb-4">Terms of Service</button>
            <button id="backToMenuFromMore" class="mt-4 bg-gray-600 hover:bg-gray-700">Back to Menu</button>
        </div>
        
        <!-- Updates Screen -->
        <div id="updatesScreen" class="screen">
            <h2 class="text-2xl font-bold mb-4 text-blue-300">Updates</h2>
            <div id="updatesList" class="flex flex-col gap-2">
                <div class="update-item flex-col items-start p-4 rounded-lg bg-gray-700">
                    <h3 class="font-bold text-lg mb-1">Version 1.2.0 - August 20, 2025</h3>
                    <ul class="list-disc list-inside text-sm text-gray-300">
                        <li><strong>FIX:</strong> Resolved the "Invalid date" bug on the "Study Sessions Over Time" chart.</li>
                        <li><strong>NEW:</strong> Implemented AI-powered, context-aware task generation to provide more unique and relevant suggestions.</li>
                        <li><strong>IMPROVEMENT:</strong> Updated app navigation to be more intuitive.</li>
                    </ul>
                </div>
            </div>
            <button id="backToMoreFromUpdates" class="mt-4 bg-gray-600 hover:bg-gray-700">Back</button>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <h2 class="text-2xl font-bold mb-4 text-blue-300">Settings</h2>
            <p class="text-gray-400 mb-6">Manage app preferences and data.</p>
            <button id="manageSubjectsButton" class="w-full mb-4">Manage Subjects</button>
            <button id="backToMoreFromSettings" class="mt-4 bg-gray-600 hover:bg-gray-700">Back</button>
        </div>

        <!-- Add/Manage Subjects Screen -->
        <div id="addSubjectScreen" class="screen">
            <h2 class="text-2xl font-bold mb-4 text-blue-300">Manage Subjects</h2>
            <input type="text" id="newSubjectInput" placeholder="Enter new subject (e.g., Math, Science)">
            <button id="addSubjectButton" class="w-full">Add Subject</button>
            <h3 class="text-xl font-semibold mt-4 mb-2">Existing Subjects</h3>
            <div id="subjectsList" class="flex flex-col gap-2">
                <!-- Subjects will be rendered here -->
            </div>
            <button id="backToSettingsFromSubjects" class="mt-4 bg-gray-600 hover:bg-gray-700">Back to Settings</button>
        </div>

        <!-- Privacy Policy Screen -->
        <div id="privacyScreen" class="screen">
            <h2 class="text-2xl font-bold mb-4 text-blue-300">Privacy Policy</h2>
            <div class="text-gray-400 text-sm leading-relaxed mb-6">
                <p><strong>Effective Date:</strong> August 20, 2025</p>
                <br>
                <p>This Privacy Policy describes how your data is collected, used, and protected. We are committed to protecting your privacy. This app collects study session data (subjects, durations) to provide personalized insights and suggestions.</p>
                <p><strong>Data Collection:</strong> We collect and store your session data securely in a private Firebase Firestore database, accessible only to you. Your user ID is automatically generated and does not contain personal information. We do not collect names, email addresses, or other personal identifiers.</p>
                <p><strong>Data Use:</strong> The collected data is used exclusively to generate study-related insights, such as suggesting topics you've studied least, and to track your personal goals and tasks. Your data is not shared with any third parties.</p>
                <p><strong>Data Security:</strong> Your data is stored in a private Firestore database with security rules that prevent unauthorized access. The connection is encrypted.</p>
                <p><strong>Your Choices:</strong> You can delete your data by deleting the app or requesting data deletion. We provide tools to manage your sessions, tasks, and goals.</p>
                <p><strong>Changes to This Policy:</strong> This policy may be updated. We will notify you of any changes by updating this page.</p>
            </div>
            <button id="backToMoreFromPrivacy" class="mt-4 bg-gray-600 hover:bg-gray-700">Back</button>
        </div>

        <!-- Terms of Service Screen -->
        <div id="termsScreen" class="screen">
            <h2 class="text-2xl font-bold mb-4 text-blue-300">Terms of Service</h2>
            <div class="text-gray-400 text-sm leading-relaxed mb-6">
                <p><strong>Effective Date:</strong> August 20, 2025</p>
                <br>
                <p>Welcome to AnalStudy! By using this application, you agree to these Terms of Service. Please read them carefully.</p>
                <p><strong>1. Use of the App:</strong> The app is provided for your personal, non-commercial use. It is designed to help you track your study sessions, manage tasks, and set goals. You agree to use the app responsibly and not for any unlawful or prohibited purpose.</p>
                <p><strong>2. Intellectual Property:</strong> All content, features, and functionality of the app are the exclusive property of the app creator and are protected by intellectual property laws. You may not copy, modify, distribute, sell, or lease any part of the app.</p>
                <p><strong>3. Disclaimer of Warranties:</strong> The app is provided "as is" and "as available" without any warranties of any kind, either express or implied. We do not guarantee that the app will be uninterrupted, error-free, or secure.</p>
                <p><strong>4. Limitation of Liability:</strong> In no event shall the app creator be liable for any indirect, incidental, special, or consequential damages arising out of or in connection with your use of the app.</p>
                <p><strong>5. Changes to Terms:</strong> We reserve the right to modify these Terms at any time. We will notify you of changes by updating this page. Your continued use of the app constitutes your acceptance of the new Terms.</p>
            </div>
            <button id="backToMoreFromTerms" class="mt-4 bg-gray-600 hover:bg-gray-700">Back</button>
        </div>

        <!-- Sessions Screen -->
        <div id="sessionsScreen" class="screen">
            <h2 class="text-2xl font-bold mb-4 text-blue-300">Past Sessions</h2>
            <div id="sessionsList" class="flex flex-col gap-2">
                <!-- Sessions will be rendered here -->
            </div>
            <button id="backToMenuFromSessions" class="mt-4 bg-gray-600 hover:bg-gray-700">Back to Menu</button>
        </div>

        <!-- Start/Stop Session Screen -->
        <div id="sessionScreen" class="screen">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Study Session</h1>
            <select id="subjectSelect" class="w-full mb-4"></select>
            <p id="pauseInfoText" class="text-sm text-center text-gray-400 mb-4">Pausing counts as idle time.</p>
            <button id="toggleStudyPauseButton" class="w-full">Start Timer</button>
            <div id="timerDisplay" class="timer-display">00:00:00</div>
            <div id="currentSubjectDisplay" class="text-center text-xl text-gray-300 mb-4"></div>
            <button id="endSessionButton" class="w-full end-button mt-auto">End Session</button>
            <p class="text-sm text-center text-gray-400 mt-2">Screen will stay on during study.</p>
        </div>

        <!-- Tasks Screen -->
        <div id="tasksScreen" class="screen">
            <h2 class="text-2xl font-bold mb-4 text-blue-300">Your Tasks</h2>
            <div id="tasksList" class="flex flex-col gap-2">
                <!-- Tasks will be rendered here -->
            </div>
            <div class="mt-4 text-center">
                <p id="taskStatusMessage" class="text-gray-400 text-sm">Loading tasks...</p>
                <button id="generateTaskButton" class="mt-4">Generate New Task</button>
            </div>
            <button id="backToMenuFromTasks" class="mt-4 bg-gray-600 hover:bg-gray-700">Back to Menu</button>
        </div>

        <!-- Goals Screen -->
        <div id="goalsScreen" class="screen">
            <h2 class="text-2xl font-bold mb-4 text-blue-300">Your Goals</h2>
            <input type="text" id="newGoalTitleInput" placeholder="Enter new goal title">
            <button id="addGoalButton" class="w-full">Add Goal</button>
            <div id="goalsList" class="flex flex-col gap-2">
                <!-- Goals will be rendered here -->
            </div>
            <button id="backToMenuFromGoals" class="mt-4 bg-gray-600 hover:bg-gray-700">Back to Menu</button>
        </div>

        <!-- Graphs & Analysis Screen -->
        <div id="graphsScreen" class="screen">
            <h2 class="text-2xl font-bold mb-4 text-blue-300">Graphs & Analysis</h2>
            <p id="analysisMessage" class="text-center text-gray-400 mb-6"></p>

            <div class="bg-gray-700 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold mb-2">Study Time Per Subject</h3>
                <canvas id="subjectBarChart"></canvas>
            </div>
            
            <div class="bg-gray-700 p-4 rounded-lg mb-6">
                <h3 class="text-lg font-semibold mb-2">Study Sessions Over Time</h3>
                <canvas id="sessionsLineChart"></canvas>
            </div>

            <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">Detailed Insights</h3>
                <div id="detailedInsights" class="text-gray-300 text-sm leading-relaxed">
                    <!-- Text insights will be rendered here -->
                </div>
            </div>

            <button id="backToMenuFromGraphs" class="mt-4 bg-gray-600 hover:bg-gray-700">Back to Menu</button>
        </div>

        <!-- Edit Session Modal -->
        <div id="editSessionModal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">Edit Session Info</h2>
                <label for="editSessionNameInput" class="text-gray-300 text-sm block text-left mb-1">Session Name:</label>
                <input type="text" id="editSessionNameInput" class="w-full">

                <label for="editSessionTopicInput" class="text-gray-300 text-sm block text-left mb-1">Main Topic:</label>
                <input type="text" id="editSessionTopicInput" class="w-full">
                
                <label for="editSessionNotesInput" class="text-gray-300 text-sm block text-left mb-1">Notes:</label>
                <textarea id="editSessionNotesInput" class="w-full" rows="4" placeholder="Add notes about your session..."></textarea>
                
                <button id="saveEditSessionButton" class="bg-blue-500 hover:bg-blue-600">Save</button>
                <button id="cancelEditSessionButton" class="bg-gray-600 hover:bg-gray-700">Cancel</button>
            </div>
        </div>

        <!-- Session Summary Modal -->
        <div id="sessionSummaryModal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">Session Complete!</h2>
                <p class="text-gray-300 text-lg mb-2">Your Focus Breakdown:</p>
                <div class="progress-bar-container">
                    <div id="studyBar" class="progress-bar" style="width: 0%;"></div>
                    <div id="idleBar" class="idle-bar" style="width: 0%;"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-400 mt-2">
                    <p id="studyTimeText">Study: 0s</p>
                    <p id="idleTimeText">Idle: 0s</p>
                </div>
                <button id="closeSummaryButton" class="bg-blue-500 hover:bg-blue-600">Got It!</button>
            </div>
        </div>
        
        <!-- Loading Modal -->
        <div id="loadingModal" class="modal">
            <div class="modal-content flex flex-col items-center">
                <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4">Generating a new task...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import {
            initializeApp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Globals and Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // --- App State Variables ---
        let sessions = [];
        let subjects = [];
        let tasks = [];
        let goals = [];
        let sessionTimerInterval = null;
        let currentSessionStartTime = 0;
        let currentSubjectStartTime = 0;
        let currentPauseStartTime = 0;
        let totalSessionStudyTime = 0;
        let totalSessionPauseTime = 0;
        let sessionSubjectsDurations = {};
        let currentSubject = '';
        let isStudying = false;
        let wakeLock = null;
        let mySubjectBarChart;
        let mySessionsLineChart;

        // --- DOM Elements ---
        const mainMenuScreen = document.getElementById('mainMenuScreen');
        const moreScreen = document.getElementById('moreScreen');
        const updatesScreen = document.getElementById('updatesScreen');
        const settingsScreen = document.getElementById('settingsScreen');
        const addSubjectScreen = document.getElementById('addSubjectScreen');
        const privacyScreen = document.getElementById('privacyScreen');
        const termsScreen = document.getElementById('termsScreen');
        const showTasksButton = document.getElementById('showTasksButton');
        const showGoalsButton = document.getElementById('showGoalsButton');
        const showSessionsButton = document.getElementById('showSessionsButton');
        const showMoreButton = document.getElementById('showMoreButton');
        const showUpdatesButton = document.getElementById('showUpdatesButton');
        const showGraphsButton = document.getElementById('showGraphsButton');
        const showSettingsButton = document.getElementById('showSettingsButton');
        const manageSubjectsButton = document.getElementById('manageSubjectsButton');
        const showPrivacyButton = document.getElementById('showPrivacyButton');
        const showTermsButton = document.getElementById('showTermsButton');
        const tasksScreen = document.getElementById('tasksScreen');
        const goalsScreen = document.getElementById('goalsScreen');
        const sessionsScreen = document.getElementById('sessionsScreen');
        const graphsScreen = document.getElementById('graphsScreen');
        const backToMenuFromTasks = document.getElementById('backToMenuFromTasks');
        const backToMenuFromGoals = document.getElementById('backToMenuFromGoals');
        const backToMenuFromSessions = document.getElementById('backToMenuFromSessions');
        const backToMenuFromGraphs = document.getElementById('backToMenuFromGraphs');
        const backToMenuFromMore = document.getElementById('backToMenuFromMore');
        const backToMoreFromUpdates = document.getElementById('backToMoreFromUpdates');
        const backToMoreFromSettings = document.getElementById('backToMoreFromSettings');
        const backToMoreFromPrivacy = document.getElementById('backToMoreFromPrivacy');
        const backToMoreFromTerms = document.getElementById('backToMoreFromTerms');
        const backToSettingsFromSubjects = document.getElementById('backToSettingsFromSubjects');
        const startNewSessionButton = document.getElementById('startNewSessionButton');
        const sessionScreen = document.getElementById('sessionScreen');
        const subjectSelect = document.getElementById('subjectSelect');
        const toggleStudyPauseButton = document.getElementById('toggleStudyPauseButton');
        const timerDisplay = document.getElementById('timerDisplay');
        const currentSubjectDisplay = document.getElementById('currentSubjectDisplay');
        const endSessionButton = document.getElementById('endSessionButton');
        const sessionsList = document.getElementById('sessionsList');
        const tasksList = document.getElementById('tasksList');
        const goalsList = document.getElementById('goalsList');
        const newGoalTitleInput = document.getElementById('newGoalTitleInput');
        const addGoalButton = document.getElementById('addGoalButton');
        const editSessionModal = document.getElementById('editSessionModal');
        const editSessionNameInput = document.getElementById('editSessionNameInput');
        const editSessionTopicInput = document.getElementById('editSessionTopicInput');
        const editSessionNotesInput = document.getElementById('editSessionNotesInput');
        const saveEditSessionButton = document.getElementById('saveEditSessionButton');
        const cancelEditSessionButton = document.getElementById('cancelEditSessionButton');
        const generateTaskButton = document.getElementById('generateTaskButton');
        const taskStatusMessage = document.getElementById('taskStatusMessage');
        const newSubjectInput = document.getElementById('newSubjectInput');
        const addSubjectButton = document.getElementById('addSubjectButton');
        const subjectsList = document.getElementById('subjectsList');
        const sessionSummaryModal = document.getElementById('sessionSummaryModal');
        const studyBar = document.getElementById('studyBar');
        const idleBar = document.getElementById('idleBar');
        const studyTimeText = document.getElementById('studyTimeText');
        const idleTimeText = document.getElementById('idleTimeText');
        const closeSummaryButton = document.getElementById('closeSummaryButton');
        const detailedInsights = document.getElementById('detailedInsights');
        const loadingModal = document.getElementById('loadingModal');

        // --- Firebase Globals and Setup ---
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase initialized and user authenticated.");
                        initializeAppLogic(); // Start app after auth is ready
                    } else {
                        console.log("No user is signed in.");
                    }
                });
            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
            }
        };

        // --- Data Fetching from Firestore ---
        const fetchUserData = () => {
            if (!isAuthReady || !db || !userId) return;

            // Fetch Sessions
            const sessionsColRef = collection(db, 'artifacts', appId, 'users', userId, 'sessions');
            onSnapshot(sessionsColRef, (snapshot) => {
                sessions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSessions();
                renderTaskStatusMessage();
                renderGraphs();
                console.log('Sessions fetched:', sessions);
            }, (error) => {
                console.error("Error fetching sessions:", error);
            });

            // Fetch Subjects
            const subjectsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'user-data', 'subjects');
            onSnapshot(subjectsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    subjects = docSnap.data().list || [];
                } else {
                    subjects = [];
                }
                renderSubjectSelect();
                renderSubjectsList();
                console.log('Subjects fetched:', subjects);
            }, (error) => {
                console.error("Error fetching subjects:", error);
            });

            // Fetch Tasks
            const tasksColRef = collection(db, 'artifacts', appId, 'users', userId, 'tasks');
            onSnapshot(tasksColRef, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks();
                console.log('Tasks fetched:', tasks);
            }, (error) => {
                console.error("Error fetching tasks:", error);
            });

            // Fetch Goals
            const goalsColRef = collection(db, 'artifacts', appId, 'users', userId, 'goals');
            onSnapshot(goalsColRef, (snapshot) => {
                goals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGoals();
                console.log('Goals fetched:', goals);
            }, (error) => {
                console.error("Error fetching goals:", error);
            });
        };

        // --- UI Functions ---
        const showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        };

        const showModal = (modalId) => {
            document.getElementById(modalId).classList.add('active');
        };

        const hideModal = (modalId) => {
            document.getElementById(modalId).classList.remove('active');
        };

        const renderTasks = () => {
            tasksList.innerHTML = '';
            const inProgressTasks = tasks.filter(t => t.status === 'in-progress' || !t.status);
            const completedTasks = tasks.filter(t => t.status === 'completed');
            const otherTasks = tasks.filter(t => t.status === 'do-later' || t.status === 'given-up');

            const renderTaskGroup = (groupTitle, groupTasks) => {
                if (groupTasks.length > 0) {
                    const groupTitleEl = document.createElement('h3');
                    groupTitleEl.className = 'text-xl font-semibold mt-4 mb-2';
                    groupTitleEl.textContent = groupTitle;
                    tasksList.appendChild(groupTitleEl);
                }
                groupTasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = `task-item flex justify-between items-center rounded-lg p-3 mb-2 ${task.status === 'completed' ? 'completed' : task.status === 'given-up' || task.status === 'do-later' ? 'given-up' : ''}`;
                    
                    const actionsHtml = `
                        <div class="flex gap-2">
                            ${task.status !== 'completed' ? `<button class="complete-task-button bg-green-500 hover:bg-green-600 px-3 py-1 text-sm rounded-md" data-id="${task.id}">Complete</button>` : ''}
                            ${task.status !== 'given-up' ? `<button class="give-up-task-button give-up-button px-3 py-1 text-sm rounded-md" data-id="${task.id}">Give Up</button>` : ''}
                            ${task.status !== 'do-later' ? `<button class="do-later-task-button do-later-button px-3 py-1 text-sm rounded-md" data-id="${task.id}">Do Later</button>` : ''}
                        </div>
                    `;
                    
                    taskItem.innerHTML = `
                        <span class="flex-1 text-left">${task.title}</span>
                        ${task.status === 'in-progress' || !task.status ? actionsHtml : ''}
                    `;
                    tasksList.appendChild(taskItem);
                });
            };

            renderTaskGroup('In Progress', inProgressTasks);
            renderTaskGroup('Completed', completedTasks);
            renderTaskGroup('Other', otherTasks);

            // Add event listeners
            tasksList.querySelectorAll('.complete-task-button').forEach(btn => btn.onclick = (e) => updateTaskStatus(e.target.dataset.id, 'completed'));
            tasksList.querySelectorAll('.give-up-task-button').forEach(btn => btn.onclick = (e) => updateTaskStatus(e.target.dataset.id, 'given-up'));
            tasksList.querySelectorAll('.do-later-task-button').forEach(btn => btn.onclick = (e) => updateTaskStatus(e.target.dataset.id, 'do-later'));
        };

        const renderGoals = () => {
            goalsList.innerHTML = '';
            const activeGoals = goals.filter(g => g.status === 'active' || !g.status);
            const completedGoals = goals.filter(g => g.status === 'completed');
            const archivedGoals = goals.filter(g => g.status === 'archived');
            
            const renderGoalGroup = (groupTitle, groupGoals, statusClass) => {
                if (groupGoals.length > 0) {
                    const groupTitleEl = document.createElement('h3');
                    groupTitleEl.className = 'text-xl font-semibold mt-4 mb-2';
                    groupTitleEl.textContent = groupTitle;
                    goalsList.appendChild(groupTitleEl);
                }
                groupGoals.forEach(goal => {
                    const goalItem = document.createElement('div');
                    goalItem.className = `goal-item flex justify-between items-center rounded-lg p-3 mb-2 ${statusClass}`;
                    
                    const actionsHtml = `
                        <div class="flex gap-2">
                            ${goal.status !== 'completed' ? `<button class="complete-goal-button bg-green-500 hover:bg-green-600 px-3 py-1 text-sm rounded-md" data-id="${goal.id}">Complete</button>` : ''}
                            ${goal.status !== 'archived' ? `<button class="archive-goal-button archive-button px-3 py-1 text-sm rounded-md" data-id="${goal.id}">Archive</button>` : ''}
                        </div>
                    `;
                    
                    goalItem.innerHTML = `
                        <span class="flex-1 text-left">${goal.title}</span>
                        ${goal.status === 'active' || !goal.status ? actionsHtml : ''}
                    `;
                    goalsList.appendChild(goalItem);
                });
            };

            renderGoalGroup('Active Goals', activeGoals, '');
            renderGoalGroup('Completed Goals', completedGoals, 'completed');
            renderGoalGroup('Archived Goals', archivedGoals, 'archived');
            
            goalsList.querySelectorAll('.complete-goal-button').forEach(btn => btn.onclick = (e) => updateGoalStatus(e.target.dataset.id, 'completed'));
            goalsList.querySelectorAll('.archive-goal-button').forEach(btn => btn.onclick = (e) => updateGoalStatus(e.target.dataset.id, 'archived'));
        };


        const renderSessions = () => {
            sessionsList.innerHTML = '';
            if (sessions.length === 0) {
                sessionsList.innerHTML = `<p class="text-center text-gray-400">No past sessions yet.</p>`;
                return;
            }
            sessions.sort((a, b) => b.timestamp - a.timestamp); // Sort by most recent
            sessions.forEach(session => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item flex justify-between items-center rounded-lg p-3 mb-2';
                sessionItem.innerHTML = `
                    <span class="flex-1 text-left">${session.name || 'Untitled Session'}</span>
                    <button class="edit-session-button edit-button px-3 py-1 text-sm rounded-md" data-id="${session.id}">Edit Info</button>
                `;
                sessionsList.appendChild(sessionItem);
            });
            sessionsList.querySelectorAll('.edit-session-button').forEach(btn => btn.onclick = (e) => openEditSessionModal(e.target.dataset.id));
        };

        const renderSubjectSelect = () => {
            subjectSelect.innerHTML = '';
            if (subjects.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No subjects. Go to Settings to add one!';
                subjectSelect.appendChild(option);
                toggleStudyPauseButton.disabled = true;
                return;
            }
            toggleStudyPauseButton.disabled = false;
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
        };
        
        const renderSubjectsList = () => {
            subjectsList.innerHTML = '';
            if (subjects.length === 0) {
                subjectsList.innerHTML = `<p class="text-center text-gray-400">No subjects added yet.</p>`;
                return;
            }
            subjects.forEach(subject => {
                const subjectItem = document.createElement('div');
                subjectItem.className = 'subject-item flex justify-between items-center rounded-lg p-3 mb-2';
                subjectItem.innerHTML = `
                    <span class="flex-1 text-left">${subject}</span>
                    <button class="delete-subject-button delete-button px-3 py-1 text-sm rounded-md" data-name="${subject}">Delete</button>
                `;
                subjectsList.appendChild(subjectItem);
            });
            subjectsList.querySelectorAll('.delete-subject-button').forEach(btn => btn.onclick = (e) => deleteSubject(e.target.dataset.name));
        };

        const renderGraphs = () => {
            const subjectData = aggregateSubjectData();
            const sessionData = aggregateSessionData();
            
            if (mySubjectBarChart) mySubjectBarChart.destroy();
            if (mySessionsLineChart) mySessionsLineChart.destroy();

            if (sessions.length === 0) {
                document.getElementById('analysisMessage').textContent = "No sessions to analyze yet. Start a new study session to see your progress here!";
                document.getElementById('subjectBarChart').style.display = 'none';
                document.getElementById('sessionsLineChart').style.display = 'none';
                detailedInsights.innerHTML = '';
                return;
            }

            document.getElementById('analysisMessage').textContent = "Your study habits at a glance.";
            document.getElementById('subjectBarChart').style.display = 'block';
            document.getElementById('sessionsLineChart').style.display = 'block';

            // Bar Chart for Subjects
            const barCtx = document.getElementById('subjectBarChart').getContext('2d');
            mySubjectBarChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(subjectData),
                    datasets: [{
                        label: 'Study Time (minutes)',
                        data: Object.values(subjectData).map(seconds => Math.round(seconds / 60)),
                        backgroundColor: '#4299e1',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#cbd5e0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#cbd5e0' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += Math.round(context.raw) + ' minutes';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // Line Chart for Sessions Over Time
            const lineCtx = document.getElementById('sessionsLineChart').getContext('2d');
            
            const sessionLabels = sessionData.map(d => new Date(d.timestamp).toLocaleDateString());
            const sessionTimes = sessionData.map(d => Math.round(d.totalStudyDuration / 60));

            mySessionsLineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: sessionLabels,
                    datasets: [{
                        label: 'Study Time (minutes)',
                        data: sessionTimes,
                        borderColor: '#48bb78',
                        backgroundColor: 'rgba(72, 187, 120, 0.2)',
                        tension: 0.3,
                        pointBackgroundColor: '#48bb78',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#cbd5e0' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#cbd5e0' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += Math.round(context.raw) + ' minutes';
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // Detailed Textual Insights
            renderDetailedInsights();
        };

        const renderDetailedInsights = () => {
            const totalStudySeconds = sessions.reduce((sum, s) => sum + (s.totalStudyDuration || 0), 0);
            const totalSessions = sessions.length;
            const avgSessionTime = totalSessions > 0 ? totalStudySeconds / totalSessions : 0;
            const formattedAvgTime = formatTime(Math.round(avgSessionTime));

            const subjectData = aggregateSubjectData();
            const sortedSubjects = Object.entries(subjectData).sort(([, a], [, b]) => b - a);
            const mostStudied = sortedSubjects.length > 0 ? sortedSubjects[0][0] : 'N/A';
            const leastStudied = sortedSubjects.length > 0 ? sortedSubjects[sortedSubjects.length - 1][0] : 'N/A';

            detailedInsights.innerHTML = `
                <p><strong>Total Study Time:</strong> ${formatTime(totalStudySeconds)}</p>
                <p><strong>Total Sessions:</strong> ${totalSessions}</p>
                <p><strong>Average Session Duration:</strong> ${formattedAvgTime}</p>
                <p><strong>Most Studied Subject:</strong> ${mostStudied}</p>
                <p><strong>Least Studied Subject:</strong> ${leastStudied}</p>
            `;
        };
        
        const renderTaskStatusMessage = () => {
            const leastStudied = findLeastStudiedTopic();
            if (leastStudied) {
                taskStatusMessage.textContent = `Need a new task? We noticed you've studied "${leastStudied.topic}" the least.`;
            } else {
                taskStatusMessage.textContent = "You've got no study history yet. Start a session to generate insights!";
            }
        };


        // --- Core App Logic Functions ---
        const formatTime = (seconds) => {
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        };

        const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock acquired!');
                } catch (err) {
                    // This error is expected in some environments (like an iframe)
                    // and doesn't prevent the app from working.
                    // We'll just silently fail to acquire the lock.
                }
            }
        };

        const releaseWakeLock = () => {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock released.');
            }
        };

        const updateTimerDisplay = () => {
            let elapsed;
            if (isStudying) {
                 elapsed = Math.floor((Date.now() - currentSessionStartTime) / 1000);
            } else {
                 elapsed = totalSessionStudyTime;
            }
            timerDisplay.textContent = formatTime(elapsed);
        };

        const toggleStudyPause = () => {
            currentSubject = subjectSelect.value;
            if (!currentSubject) {
                // Use custom modal or a simple message for feedback
                const message = document.createElement('div');
                message.textContent = 'Please select a subject to start studying.';
                message.className = 'text-center text-red-400 font-bold mb-2';
                sessionScreen.insertBefore(message, subjectSelect.nextSibling);
                setTimeout(() => message.remove(), 3000);
                return;
            }

            if (!isStudying) {
                // Start a new session or resume
                if (currentSessionStartTime === 0) {
                    currentSessionStartTime = Date.now();
                }
                
                if (currentPauseStartTime !== 0) {
                    totalSessionPauseTime += Math.floor((Date.now() - currentPauseStartTime) / 1000);
                    currentPauseStartTime = 0;
                }
                
                isStudying = true;
                currentSubjectStartTime = Date.now();
                
                clearInterval(sessionTimerInterval);
                sessionTimerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - currentSubjectStartTime) / 1000);
                    sessionSubjectsDurations[currentSubject] = (sessionSubjectsDurations[currentSubject] || 0) + 1;
                    totalSessionStudyTime = Math.floor((Date.now() - currentSessionStartTime) / 1000) - totalSessionPauseTime;
                    updateTimerDisplay();
                }, 1000);

                requestWakeLock();
                toggleStudyPauseButton.textContent = "Pause Study";
                subjectSelect.disabled = true;
                currentSubjectDisplay.textContent = `Studying: ${currentSubject}`;
            } else {
                // Pause the session
                isStudying = false;
                clearInterval(sessionTimerInterval);
                currentPauseStartTime = Date.now();
                releaseWakeLock();
                toggleStudyPauseButton.textContent = "Resume Study";
                currentSubjectDisplay.textContent = 'Paused';
                subjectSelect.disabled = false;
            }
        };


        const endSession = async () => {
            clearInterval(sessionTimerInterval);
            if (isStudying) {
                totalSessionStudyTime = Math.floor((Date.now() - currentSessionStartTime) / 1000) - totalSessionPauseTime;
                sessionSubjectsDurations[currentSubject] += Math.floor((Date.now() - currentSubjectStartTime) / 1000);
            }
            if (!isStudying && currentPauseStartTime !== 0) {
                totalSessionPauseTime += Math.floor((Date.now() - currentPauseStartTime) / 1000);
            }
            releaseWakeLock();

            // Show summary modal
            showSessionSummary();

            const sessionData = {
                name: `Session on ${new Date().toLocaleDateString()}`,
                timestamp: Date.now(),
                totalStudyDuration: totalSessionStudyTime,
                totalPauseDuration: totalSessionPauseTime,
                subjectsStudied: { ...sessionSubjectsDurations }
            };

            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'sessions'), sessionData);
            
            // Reset state
            totalSessionStudyTime = 0;
            totalSessionPauseTime = 0;
            sessionSubjectsDurations = {};
            currentSubject = '';
            currentSessionStartTime = 0;
            currentSubjectStartTime = 0;
            currentPauseStartTime = 0;
            isStudying = false;
            timerDisplay.textContent = '00:00:00';
            currentSubjectDisplay.textContent = '';
            toggleStudyPauseButton.textContent = 'Start Timer';
            subjectSelect.disabled = false;
        };

        const showSessionSummary = () => {
            const totalDuration = totalSessionStudyTime + totalSessionPauseTime;
            const studyPercentage = totalDuration > 0 ? (totalSessionStudyTime / totalDuration) * 100 : 0;
            const idlePercentage = totalDuration > 0 ? (totalSessionPauseTime / totalDuration) * 100 : 0;

            studyBar.style.width = `${studyPercentage}%`;
            idleBar.style.width = `${idlePercentage}%`;
            studyTimeText.textContent = `Study: ${formatTime(totalSessionStudyTime)}`;
            idleTimeText.textContent = `Idle: ${formatTime(totalSessionPauseTime)}`;

            showModal('sessionSummaryModal');
        };

        const addSubject = async () => {
            const newSubject = newSubjectInput.value.trim();
            if (!newSubject) return;

            const subjectsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'user-data', 'subjects');
            
            const existingSubjects = subjects || [];
            if (!existingSubjects.includes(newSubject)) {
                existingSubjects.push(newSubject);
                await setDoc(subjectsDocRef, { list: existingSubjects }, { merge: true });
                newSubjectInput.value = '';
            } else {
                const message = document.createElement('div');
                message.textContent = 'This subject already exists!';
                message.className = 'text-center text-red-400 font-bold mb-2';
                addSubjectScreen.insertBefore(message, newSubjectInput.nextSibling);
                setTimeout(() => message.remove(), 3000);
            }
        };

        const deleteSubject = async (subjectName) => {
            const subjectsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'user-data', 'subjects');
            const updatedSubjects = subjects.filter(s => s !== subjectName);
            await setDoc(subjectsDocRef, { list: updatedSubjects });
        };

        const addGoal = async (title) => {
            if (!title) return;
            const goalData = {
                title,
                status: 'active',
                createdAt: Date.now()
            };
            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'goals'), goalData);
            newGoalTitleInput.value = '';
        };

        const updateGoalStatus = async (goalId, status) => {
            const goalRef = doc(db, 'artifacts', appId, 'users', userId, 'goals', goalId);
            await updateDoc(goalRef, { status });
        };

        const updateTaskStatus = async (taskId, status) => {
            const taskRef = doc(db, 'artifacts', appId, 'users', userId, 'tasks', taskId);
            await updateDoc(taskRef, { status, completedAt: Date.now() });
        };

        const findLeastStudiedTopic = () => {
            if (sessions.length === 0) {
                return null;
            }
            
            const allSubjects = aggregateSubjectData();
            if (Object.keys(allSubjects).length === 0) {
                return null; // No topics have been studied yet
            }

            const sortedSubjects = Object.entries(allSubjects).sort((a, b) => a[1] - b[1]);
            return {
                topic: sortedSubjects[0][0],
                time: sortedSubjects[0][1]
            };
        };

        // LLM-powered task generation function
        const generateTaskWithAI = async () => {
            // Check if there are existing in-progress tasks
            const activeTasks = tasks.filter(t => t.status === 'in-progress' || !t.status);
            if (activeTasks.length > 0) {
                const message = document.createElement('div');
                message.textContent = 'You already have an in-progress task. Please complete or give it up first.';
                message.className = 'text-center text-red-400 font-bold mb-2';
                tasksScreen.insertBefore(message, tasksList.nextSibling);
                setTimeout(() => message.remove(), 5000);
                return;
            }

            if (subjects.length === 0) {
                const message = document.createElement('div');
                message.textContent = 'Please add at least one subject to generate a task.';
                message.className = 'text-center text-red-400 font-bold mb-2';
                tasksScreen.insertBefore(message, tasksList.nextSibling);
                setTimeout(() => message.remove(), 5000);
                return;
            }

            showModal('loadingModal');
            let newTaskTitle = "Review your notes for today's session.";

            try {
                const subjectData = aggregateSubjectData();
                const sessionData = aggregateSessionData();
                
                const mostStudied = Object.entries(subjectData).sort(([, a], [, b]) => b - a)[0];
                const leastStudied = Object.entries(subjectData).sort(([, a], [, b]) => a - b)[0];
                const totalStudyTime = sessions.reduce((sum, s) => sum + (s.totalStudyDuration || 0), 0);
                const avgSessionDuration = totalStudyTime > 0 ? totalStudyTime / sessions.length : 0;

                const prompt = `Based on the user's study data, generate a single, compelling, and actionable study task. The task should be presented in a friendly, encouraging tone. Do not use markdown formatting like headings or lists, just a single, concise sentence.
                User's Subjects: ${subjects.join(', ')}
                Study History: ${JSON.stringify(subjectData)}
                Total Study Time: ${formatTime(totalStudyTime)}
                Average Session Duration: ${formatTime(avgSessionDuration)}
                Most Studied Subject: ${mostStudied ? mostStudied[0] : 'None'}
                Least Studied Subject: ${leastStudied ? leastStudied[0] : 'None'}

                Example tasks based on this data could be:
                - "Focus on your least studied subject, ${leastStudied ? leastStudied[0] : ''}, for at least 15 minutes."
                - "Review your most studied subject, ${mostStudied ? mostStudied[0] : ''}, by trying to recall three key concepts without looking at your notes."
                - "Try a short, 20-minute burst of focused work on a new topic within one of your subjects."
                - "Summarize a key topic from your last session in a single paragraph."

                Generate a new, unique task title now.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "" 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                let retries = 0;
                const maxRetries = 3;
                let response;

                while (retries < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) {
                            retries++;
                            const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                            newTaskTitle = result.candidates[0].content.parts[0].text;
                            break; // Success, exit loop
                        } else {
                            throw new Error("Invalid API response format");
                        }
                    } catch (error) {
                        console.error("API call failed:", error);
                        retries++;
                        const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                        await new Promise(res => setTimeout(res, delay));
                    }
                }
            } catch (err) {
                console.error("Task generation failed, using fallback:", err);
                newTaskTitle = "Review your notes for today's session.";
            } finally {
                hideModal('loadingModal');
            }

            const taskData = {
                title: newTaskTitle,
                status: 'in-progress',
                createdAt: Date.now()
            };
            await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'tasks'), taskData);
        };

        const openEditSessionModal = (sessionId) => {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            editSessionNameInput.value = session.name || '';
            editSessionTopicInput.value = session.topic || '';
            editSessionNotesInput.value = session.notes || '';
            
            editSessionModal.dataset.sessionId = sessionId;
            showModal('editSessionModal');
        };

        const saveEditSession = async () => {
            const sessionId = editSessionModal.dataset.sessionId;
            const sessionRef = doc(db, 'artifacts', appId, 'users', userId, 'sessions', sessionId);
            const updatedData = {
                name: editSessionNameInput.value,
                topic: editSessionTopicInput.value,
                notes: editSessionNotesInput.value
            };

            await updateDoc(sessionRef, updatedData);
            hideModal('editSessionModal');
        };

        const aggregateSubjectData = () => {
            const subjectData = {};
            sessions.forEach(session => {
                if (session.subjectsStudied) {
                    for (const subject in session.subjectsStudied) {
                        subjectData[subject] = (subjectData[subject] || 0) + (session.subjectsStudied[subject] || 0);
                    }
                }
            });
            return subjectData;
        };

        const aggregateSessionData = () => {
            // Sort sessions by timestamp to ensure chronological order
            sessions.sort((a, b) => a.timestamp - b.timestamp);
            return sessions.map(session => ({
                timestamp: session.timestamp,
                totalStudyDuration: session.totalStudyDuration || 0
            }));
        };

        // --- Event Listeners ---
        showTasksButton.onclick = () => showScreen('tasksScreen');
        showGoalsButton.onclick = () => showScreen('goalsScreen');
        showGraphsButton.onclick = () => showScreen('graphsScreen');
        showSessionsButton.onclick = () => showScreen('sessionsScreen');
        showMoreButton.onclick = () => showScreen('moreScreen');
        showUpdatesButton.onclick = () => showScreen('updatesScreen');
        showSettingsButton.onclick = () => showScreen('settingsScreen');
        manageSubjectsButton.onclick = () => showScreen('addSubjectScreen');
        showPrivacyButton.onclick = () => showScreen('privacyScreen');
        showTermsButton.onclick = () => showScreen('termsScreen');
        startNewSessionButton.onclick = () => showScreen('sessionScreen');
        backToMenuFromTasks.onclick = () => showScreen('mainMenuScreen');
        backToMenuFromGoals.onclick = () => showScreen('mainMenuScreen');
        backToMenuFromSessions.onclick = () => showScreen('mainMenuScreen');
        backToMenuFromGraphs.onclick = () => showScreen('mainMenuScreen');
        backToMenuFromMore.onclick = () => showScreen('mainMenuScreen');
        backToMoreFromUpdates.onclick = () => showScreen('moreScreen');
        backToMoreFromSettings.onclick = () => showScreen('moreScreen');
        backToMoreFromPrivacy.onclick = () => showScreen('moreScreen');
        backToMoreFromTerms.onclick = () => showScreen('moreScreen');
        backToSettingsFromSubjects.onclick = () => showScreen('settingsScreen');
        toggleStudyPauseButton.onclick = toggleStudyPause;
        endSessionButton.onclick = endSession;
        generateTaskButton.onclick = generateTaskWithAI;
        addGoalButton.onclick = () => addGoal(newGoalTitleInput.value);
        addSubjectButton.onclick = addSubject;
        saveEditSessionButton.onclick = saveEditSession;
        cancelEditSessionButton.onclick = () => hideModal('editSessionModal');
        
        // Updated closeSummaryButton to navigate to main menu
        closeSummaryButton.onclick = () => {
            hideModal('sessionSummaryModal');
            showScreen('mainMenuScreen');
        };
        
        // --- Initialization ---
        const initializeAppLogic = () => {
            fetchUserData();
            showScreen('mainMenuScreen'); // Start with the main menu screen
        };

        window.onload = () => {
            initFirebase();
        };

    </script>
</body>
</html>
