<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnalStudy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global Firebase variables (will be initialized in main script)
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null; // Firebase Auth UID
        window.userAnalId = null; // Custom Anal ID for pairing

        // Initialize Firebase
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use provided app ID

        if (Object.keys(firebaseConfig).length > 0) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // Authenticate with custom token or anonymously
            onAuthStateChanged(window.auth, async (user) => {
                if (!user) {
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(window.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (error) {
                        console.error("Firebase authentication failed:", error);
                    }
                }
                window.userId = window.auth.currentUser?.uid || crypto.randomUUID(); // Fallback for userId
                console.log("Firebase initialized. User ID:", window.userId);
                // Trigger app initialization after Firebase is ready
                window.dispatchEvent(new CustomEvent('firebaseReady'));
            });
        } else {
            console.warn("Firebase config not found. Running in local-only mode.");
            // If no Firebase config, proceed with local-only mode after a short delay
            setTimeout(() => {
                window.userId = crypto.randomUUID(); // Generate a local ID
                window.dispatchEvent(new CustomEvent('firebaseReady'));
            }, 100);
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        .app-container {
            width: 100%;
            max-width: 400px; /* Average smartphone width */
            height: 100vh; /* Full viewport height */
            max-height: 800px; /* Average smartphone height */
            background-color: #2d3748; /* Slightly lighter dark background for the app */
            border-radius: 1.5rem; /* Rounded corners */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Hide scrollbars for internal content */
        }
        .screen {
            display: none;
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto; /* Enable scrolling for content within screens */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .screen.active {
            display: flex;
            flex-direction: column;
        }
        input, button, select {
            border-radius: 0.75rem; /* Rounded corners for inputs/buttons */
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            font-size: 1rem;
            color: #e2e8f0;
            background-color: #4a5568; /* Darker input background */
            border: 1px solid #4a5568;
            outline: none;
            transition: all 0.2s ease-in-out;
        }
        input[type="date"] {
            -webkit-appearance: none; /* Remove default date input styling */
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23e2e8f0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>');
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25rem;
            padding-right: 2.5rem; /* Make space for the icon */
        }
        input:focus, select:focus {
            border-color: #63b3ed; /* Blue focus border */
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.5);
        }
        button {
            cursor: pointer;
            background-color: #4299e1; /* Blue button */
            font-weight: 600;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background-color: #3182ce; /* Darker blue on hover */
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .delete-button {
            background-color: #e53e3e; /* Red for delete */
        }
        .delete-button:hover {
            background-color: #c53030;
        }
        .edit-button { /* New style for edit button */
            background-color: #48bb78; /* Green */
        }
        .edit-button:hover {
            background-color: #38a169;
        }
        .end-button {
            background-color: #e53e3e; /* Red for end session */
        }
        .end-button:hover {
            background-color: #c53030;
        }
        .subject-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #4a5568;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .subject-item span {
            flex-grow: 1;
        }
        .subject-item button {
            margin-left: 1rem;
            margin-bottom: 0;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        .timer-display {
            font-size: 3rem;
            font-weight: 700;
            text-align: center;
            margin-top: 2rem;
            margin-bottom: 2rem;
            color: #63b3ed; /* Blue for timer */
        }
        .message-box {
            background-color: #2b6cb0; /* Blue for info messages */
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #4a5568;
            border-radius: 0.5rem;
            height: 1.5rem;
            margin-bottom: 0.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #63b3ed;
            width: 0%;
            border-radius: 0.5rem;
            transition: width 0.5s ease-out;
        }
        .idle-bar {
            background-color: #6b7280; /* Grey for idle time */
        }
        .session-card { /* Style for individual session cards in All Sessions Overview */
            background-color: #4a5568;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .session-card h3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .session-card h3 span {
            flex-grow: 1;
        }
        .session-card button {
            margin-left: 0.5rem;
            margin-bottom: 0;
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            border-radius: 0.5rem;
        }
        .chart-container {
            position: relative;
            height: 250px; /* Fixed height for charts */
            width: 100%;
            margin-bottom: 1.5rem;
            background-color: #3d4858;
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .privacy-checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .privacy-checkbox-container input[type="checkbox"] {
            margin-right: 0.5rem;
            margin-bottom: 0; /* Override default margin-bottom for inputs */
            width: auto; /* Adjust width for checkbox */
        }
        /* Update Notification Screen Styling */
        .update-notification-screen {
            background-color: #2d3748;
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            padding: 2rem;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .update-notification-screen h1 {
            color: #4299e1;
            font-size: 2.25rem;
            margin-bottom: 1.5rem;
        }
        .update-notification-screen h2 {
            color: #63b3ed;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .update-notification-screen ul {
            list-style: none; /* Remove default bullet */
            padding-left: 0;
            margin-bottom: 1.5rem;
        }
        .update-notification-screen ul li {
            background-color: #4a5568;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            text-align: left;
            color: #e2e8f0;
            font-size: 0.95rem;
        }

        /* Modal Styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .modal-content {
            background-color: #2d3748;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        .modal-content h2 {
            color: #63b3ed;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .modal-content p {
            color: #e2e8f0;
            margin-bottom: 1rem;
        }
        .modal-content input {
            background-color: #4a5568;
            border: 1px solid #4a5568;
            color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            margin-bottom: 1rem;
        }
        .modal-content button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            margin: 0 0.5rem;
        }
        .modal-content .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .modal-content .button-group button {
            margin-bottom: 0; /* Override default margin-bottom */
        }
        .help-icon {
            font-size: 0.8em;
            vertical-align: super;
            cursor: pointer;
            color: #63b3ed;
            margin-left: 0.2em;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Initial Auth Screen -->
        <div id="initialAuthScreen" class="screen active">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">AnalStudy</h1>
            <p class="text-center mb-4">Welcome back or join us!</p>
            <button id="loginAnalIdButton" class="w-full">Login using Anal ID <span class="help-icon" data-help="login-anal-id">?</span></button>
            <button id="signupButton" class="w-full mt-4">Signup</button>
        </div>

        <!-- Privacy Policy Screen -->
        <div id="privacyPolicyScreen" class="screen">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Privacy Policy</h1>
            <p class="mb-4 text-gray-300">Please read our privacy policy before continuing:</p>
            <ul class="list-disc list-inside text-gray-400 mb-6">
                <li>Your data may be lost during an update.</li>
                <li>Your data, such as your name and school, is stored locally in your browser's cache and is not collected, used, or transmitted by Strixel Studios.</li>
                <li>Updates may not apply to older sessions so please understand.</li>
            </ul>
            <div class="privacy-checkbox-container">
                <input type="checkbox" id="privacyAcceptCheckbox">
                <label for="privacyAcceptCheckbox" class="text-gray-300 text-sm">I understand and agree to the privacy policy.</label>
            </div>
            <button id="privacyContinueButton" class="w-full" disabled>Continue</button>
        </div>

        <!-- Update Notification Screen -->
        <div id="updateNotificationScreen" class="screen update-notification-screen">
            <h1 class="text-3xl font-bold mb-6">New Update!</h1>
            <h2 id="updateTitle" class="text-2xl font-semibold mb-4"></h2>
            <ul id="updateNotes" class="mb-6">
                <!-- Update notes will be dynamically inserted here -->
            </ul>
            <button id="updateContinueButton" class="w-full">Continue to App</button>
        </div>

        <!-- Menu Screen (Signup) -->
        <div id="menuScreen" class="screen">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">AnalStudy</h1>
            <p class="text-center mb-4">Welcome! Please tell us a bit about yourself.</p>
            <input type="text" id="userNameInput" placeholder="Your Name" class="w-full">
            <input type="text" id="schoolNameInput" placeholder="School Name (Optional)" class="w-full">
            <button id="enterAppButton" class="w-full">Enter App</button>
            <p class="text-sm text-center text-gray-400 mt-4">Your data will be saved to the cloud.</p>
        </div>

        <!-- Main App Screen -->
        <div id="mainAppScreen" class="screen">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Subjects</h1>
            <div id="subjectsList" class="flex flex-col mb-4">
                <!-- Subjects will be loaded here -->
            </div>
            <input type="text" id="newSubjectInput" placeholder="Add New Subject" class="w-full">
            <button id="addSubjectButton" class="w-full mb-4">Add Subject</button>

            <button id="startStudyingButton" class="w-full mt-auto">Start Studying</button>
            <button id="viewAllSessionsButton" class="w-full mt-4">View All Sessions</button>
            <button id="settingsButton" class="w-full mt-4">Settings</button>
            <p class="text-sm text-right text-gray-400 opacity-70 mt-auto">By Sathvik Harish, Strixel Studios.</p>
        </div>

        <!-- Study Session Screen -->
        <div id="studySessionScreen" class="screen">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Study Session</h1>
            <select id="subjectSelect" class="w-full mb-4"></select>
            <p id="pauseInfoText" class="text-sm text-center text-gray-400 mb-4">Pausing counts as idle time and when you do start the timer again it will reset to 0:00</p>
            <button id="toggleStudyPauseButton" class="w-full">Start Timer</button>
            <div id="timerDisplay" class="timer-display">00:00:00</div>
            <div id="currentSubjectDisplay" class="text-center text-xl text-gray-300 mb-4"></div>

            <div class="flex flex-col gap-4 mt-auto">
                <button id="endSessionButton" class="w-full end-button">End Session</button>
            </div>
            <div id="wakeLockMessage" class="message-box mt-4" style="display: none;">
                Screen will stay on during study.
            </div>
        </div>

        <!-- Current Session Overview Screen -->
        <div id="overviewScreen" class="screen">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Session Overview</h1>
            <p id="sessionSummaryText" class="text-center text-lg text-gray-300 mb-6"></p>
            <p class="text-xl font-semibold mb-4 text-center">What you studied:</p>
            <div id="overviewSubjects" class="flex flex-col gap-2 mb-6">
                <!-- Overview subjects and times will be loaded here -->
            </div>
            <p class="text-xl font-semibold mb-2 text-center">Session Breakdown:</p>
            <p id="overviewTotalStudyTime" class="text-center text-lg text-blue-300 mb-1"></p>
            <p id="overviewTotalIdleTime" class="text-center text-lg text-gray-400 mb-4"></p>
            <p class="text-xl font-semibold mb-4 text-center">Total Session Duration:</p>
            <div id="totalSessionDurationDisplay" class="timer-display text-2xl mb-6">00:00:00</div>
            <button id="backToMainButton" class="w-full mt-auto">Back to Main Menu</button>
        </div>

        <!-- All Sessions Overview Screen -->
        <div id="allSessionsOverviewScreen" class="screen">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">All Past Sessions</h1>
            <div id="pastSessionsList" class="flex flex-col gap-4 mb-6">
                <!-- Past sessions will be loaded here -->
            </div>
            <button id="viewTotalOverviewButton" class="w-full mt-auto">View Total Overview</button>
            <button id="backToMainFromAllSessionsButton" class="w-full mt-4">Back to Main Menu</button>
        </div>

        <!-- Total Overview Screen -->
        <div id="totalOverviewScreen" class="screen">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Total Study Analytics</h1>
            <p id="totalOverviewSummary" class="text-center text-lg text-gray-300 mb-6"></p>

            <div class="flex flex-col sm:flex-row sm:gap-4 mb-6">
                <div class="flex-1">
                    <label for="fromDateInput" class="text-gray-300 text-sm mb-1 block">From Date:</label>
                    <input type="date" id="fromDateInput" class="w-full">
                </div>
                <div class="flex-1">
                    <label for="toDateInput" class="text-gray-300 text-sm mb-1 block">To Date:</label>
                    <input type="date" id="toDateInput" class="w-full">
                </div>
            </div>
            <button id="filterChartsButton" class="w-full mb-6">Apply Filter</button>
            <button id="clearFilterButton" class="w-full mb-6 bg-gray-600 hover:bg-gray-700">Clear Filter</button>


            <h2 class="text-xl font-semibold mb-2 text-blue-300">Study Time Trend (per session)</h2>
            <div class="chart-container">
                <canvas id="studyTimeTrendChart"></canvas>
            </div>

            <h2 class="text-xl font-semibold mb-2 text-blue-300">Idle Time Trend (per session)</h2>
            <div class="chart-container">
                <canvas id="idleTimeTrendChart"></canvas>
            </div>

            <h2 class="text-xl font-semibold mb-2 text-blue-300">Daily Study Time</h2>
            <div class="chart-container">
                <canvas id="dailyStudyChart"></canvas>
            </div>

            <h2 class="text-xl font-semibold mb-2 text-blue-300">Top Subjects Studied Overall</h2>
            <div class="chart-container">
                <canvas id="subjectsOverallChart"></canvas>
            </div>

            <button id="backToAllSessionsButton" class="w-full mt-auto">Back to All Sessions</button>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Settings</h1>
            <p class="text-center mb-4">Update your profile information.</p>
            <label for="settingsUserNameInput" class="text-gray-300 text-sm mb-1 block">Your Name:</label>
            <input type="text" id="settingsUserNameInput" placeholder="Your Name" class="w-full">
            <label for="settingsSchoolNameInput" class="text-gray-300 text-sm mb-1 block">School Name (Optional):</label>
            <input type="text" id="settingsSchoolNameInput" placeholder="School Name (Optional)" class="w-full mb-4">
            <button id="saveSettingsButton" class="w-full">Save Settings</button>
            <button id="pairDeviceButton" class="w-full mt-4">Pair with New Device</button>
            <button id="viewPrivacyPolicyButton" class="w-full mt-4">View Privacy Policy</button>
            <button id="patchNotesButton" class="w-full mt-4">Patch Notes & Updates</button>
            <button id="helpButton" class="w-full mt-4">Help</button>
            <button id="backToMainFromSettingsButton" class="w-full mt-4">Back to Main Menu</button>
        </div>

        <!-- Patch Notes Screen -->
        <div id="patchNotesScreen" class="screen">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Patch Notes & Updates</h1>
            <ul id="patchNotesList" class="list-disc list-inside text-gray-300 mb-6">
                <!-- Patch notes will be dynamically inserted here -->
            </ul>
            <p class="text-sm text-gray-400 mt-6">-> If there is an update, this app updates automatically.</p>
            <p class="text-sm text-gray-400">-> After an update, please note that it might not apply to the sessions done before the update.</p>
            <button id="backToSettingsFromPatchNotesButton" class="w-full mt-auto">Back to Settings</button>
        </div>

        <!-- Help Screen -->
        <div id="helpScreen" class="screen">
            <h1 class="text-3xl font-bold text-center mb-6 text-blue-400">Help & Features</h1>
            <h2 class="text-xl font-semibold text-blue-300 mb-2">Getting Started:</h2>
            <ul class="list-disc list-inside text-gray-300 mb-4">
                <li>On first launch, choose "Signup" to create a new account or "Login using Anal ID" to pair an existing account.</li>
                <li>After signup/login, accept the Privacy Policy.</li>
                <li>Enter your Name and School (optional) on the welcome screen (for new signups).</li>
            </ul>

            <h2 class="text-xl font-semibold text-blue-300 mb-2">Subjects:</h2>
            <ul class="list-disc list-inside text-gray-300 mb-4">
                <li>Add new subjects using the input field and "Add Subject" button.</li>
                <li>Remove existing subjects using the "Remove" button next to each subject.</li>
            </ul>

            <h2 class="text-xl font-semibold text-blue-300 mb-2">Study Session:</h2>
            <ul class="list-disc list-inside text-gray-300 mb-4">
                <li>Select a subject from the dropdown.</li>
                <li>Click "Start Timer" to begin studying. The screen will stay on.</li>
                <li>Click "Pause Study" to temporarily stop the timer. This time counts as idle time.</li>
                <li>While paused, you can change the subject.</li>
                <li>Click "Resume Study" to continue studying the selected subject. The timer for the current segment will reset to 0:00.</li>
                <li>Click "End Session" to finish your study session and view its overview.</li>
            </ul>

            <h2 class="text-xl font-semibold text-blue-300 mb-2">Session Overview:</h2>
            <ul class="list-disc list-inside text-gray-300 mb-4">
                <li>Shows a summary of your most focused subject.</li>
                <li>Displays time spent on each subject with a progress bar.</li>
                <li>Breaks down total time into "Active Study Time" and "Idle/Paused Time".</li>
            </ul>

            <h2 class="text-xl font-semibold text-blue-300 mb-2">All Past Sessions:</h2>
            <ul class="list-disc list-inside text-gray-300 mb-4">
                <li>View a list of all your past study sessions.</li>
                <li>Click "Edit Name" next to a session to give it a custom name.</li>
                <li>Click "Delete" next to a session to permanently remove it from your history.</li>
                <li>Click "View Total Overview" for aggregated analytics.</li>
            </ul>

            <h2 class="text-xl font-semibold text-blue-300 mb-2">Total Study Analytics:</h2>
            <ul class="list-disc list-inside text-gray-300 mb-4">
                <li>Provides an overall summary of your study history.</li>
                <li>**Filter by Date:** Use "From Date" and "To Date" inputs to analyze data within a specific period.</li>
                <li>**Study Time Trend (per session):** A line graph showing your active study duration for each session over time.</li>
                <li>**Idle Time Trend (per session):** A line graph showing your idle/paused time for each session over time.</li>
                <li>**Daily Study Time:** A bar graph showing your total active study time aggregated by day.</li>
                <li>**Top Subjects Studied Overall:** A bar chart displaying the total time spent on each subject across all sessions.</li>
            </ul>

            <h2 class="text-xl font-semibold text-blue-300 mb-2">Settings:</h2>
            <ul class="list-disc list-inside text-gray-300 mb-4">
                <li>Change your Name and School.</li>
                <li>**Pair with New Device:** Get your unique Anal ID to log in on other devices.</li>
                <li>View the Privacy Policy.</li>
                <li>Access "Patch Notes & Updates" for app version history.</li>
                <li>Access this "Help" section.</li>
            </ul>

            <button id="backToSettingsFromHelpButton" class="w-full mt-auto">Back to Settings</button>
        </div>

        <!-- Modals -->
        <!-- Rename Session Modal -->
        <div id="renameModal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">Rename Session</h2>
                <input type="text" id="newSessionNameInput" placeholder="Enter new session name">
                <div class="button-group">
                    <button id="cancelRenameButton" class="bg-gray-600 hover:bg-gray-700">Cancel</button>
                    <button id="confirmRenameButton" class="bg-blue-500 hover:bg-blue-600">Rename</button>
                </div>
            </div>
        </div>

        <!-- Anal ID Input Modal -->
        <div id="analIdInputModal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">Enter Anal ID <span class="help-icon" data-help="anal-id-input">?</span></h2>
                <input type="text" id="analIdLoginInput" placeholder="Enter your Anal ID">
                <div class="button-group">
                    <button id="cancelAnalIdLoginButton" class="bg-gray-600 hover:bg-gray-700">Cancel</button>
                    <button id="submitAnalIdLoginButton" class="bg-blue-500 hover:bg-blue-600">Login</button>
                </div>
            </div>
        </div>

        <!-- Anal ID Display Modal -->
        <div id="analIdDisplayModal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">Your Anal ID</h2>
                <p class="text-gray-300 mb-4">Use this ID to log in on other devices:</p>
                <p id="displayedAnalId" class="text-blue-300 text-2xl font-bold break-all mb-4"></p>
                <div class="button-group justify-center">
                    <button id="copyAnalIdButton" class="bg-blue-500 hover:bg-blue-600">Copy ID</button>
                    <button id="closeAnalIdDisplayButton" class="bg-gray-600 hover:bg-gray-700">Close</button>
                </div>
            </div>
        </div>

        <!-- Verification Modal -->
        <div id="verificationModal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-bold mb-4">Verify Account <span class="help-icon" data-help="verification">?</span></h2>
                <p class="text-gray-300 mb-4">Please enter the name and school associated with this Anal ID to verify.</p>
                <input type="text" id="verifyNameInput" placeholder="Your Name">
                <input type="text" id="verifySchoolInput" placeholder="School Name (Optional)">
                <div class="button-group">
                    <button id="cancelVerificationButton" class="bg-gray-600 hover:bg-gray-700">Cancel</button>
                    <button id="submitVerificationButton" class="bg-blue-500 hover:bg-blue-600">Verify</button>
                </div>
            </div>
        </div>

        <!-- Help Modals -->
        <div id="helpModal" class="modal">
            <div class="modal-content">
                <h2 id="helpModalTitle" class="text-xl font-bold mb-4"></h2>
                <p id="helpModalContent" class="text-gray-300 mb-4"></p>
                <div class="button-group justify-center">
                    <button id="closeHelpModalButton" class="bg-blue-500 hover:bg-blue-600">Got It!</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Define app versions and patch notes
        const patchNotesData = [
            {
                version: "1.0",
                title: "Initial Release",
                notes: [
                    "Basic study timer, subject management, and session overview."
                ]
            },
            {
                version: "1.1",
                title: "Bug Fixes & Enhanced Overview",
                notes: [
                    "Fixed timer responsiveness bug.",
                    "Added total break time and break count to session overview."
                ]
            },
            {
                version: "1.2",
                title: "Simplified Timer & Idle Tracking",
                notes: [
                    "Removed dedicated break feature, implemented single pause/resume button.",
                    "Tracked idle time, and updated overview to show active study vs. idle time."
                ]
            },
            {
                version: "1.3",
                title: "Session Naming & Total Analytics",
                notes: [
                    "Added ability to name past sessions.",
                    "Introduced 'Total Study Analytics' screen with line graphs for study time trends and bar charts for overall subjects studied."
                ]
            },
            {
                version: "1.4",
                title: "Settings Menu, Delete Session & Privacy Policy",
                notes: [
                    "Added settings menu for name/school.",
                    "Added delete session feature.",
                    "Implemented a mandatory privacy policy on first launch (or if not accepted)."
                ]
            },
            {
                version: "1.5",
                title: "Advanced Analytics & Filtering",
                notes: [
                    "Added 'Daily Study Time' and 'Idle Time Trend' graphs to total overview.",
                    "Implemented date range filtering for all total overview charts."
                ]
            },
            {
                version: "1.6",
                title: "New Update Notification & Enhanced UX",
                notes: [
                    "Implemented a one-time update notification screen on new app versions.",
                    "Added a 'Delete Session' confirmation modal for better user experience.",
                    "Updated Patch Notes and Help sections to reflect all changes."
                ]
            },
            {
                version: "1.7", // Current version
                title: "Cloud Sync & Multi-Device Pairing",
                notes: [
                    "Integrated Firebase Firestore for cloud data storage and synchronization.",
                    "Introduced 'Anal ID' for seamless login and pairing across multiple devices.",
                    "New initial login/signup screen for improved user onboarding.",
                    "All user data (name, school, subjects, sessions) now saved to the cloud.",
                    "Updated help and patch notes to include new authentication features."
                ]
            }
        ];
        const currentAppVersion = "1.7"; // Define the current version of the app

        // Help content for tooltips
        const helpContent = {
            "login-anal-id": {
                title: "Login using Anal ID",
                content: "If you've already signed up on another device, you can use your unique 'Anal ID' to log in here and sync your data."
            },
            "anal-id-input": {
                title: "Enter Your Anal ID",
                content: "This is the unique ID generated when you first signed up. Enter it here to log in and access your saved study data."
            },
            "verification": {
                title: "Account Verification",
                content: "To ensure it's you, please enter the Name and School (if provided during signup) associated with the Anal ID you entered."
            },
            "pair-device": {
                title: "Pair with New Device",
                content: "Your unique Anal ID is displayed here. Copy this ID and use it on another device by selecting 'Login using Anal ID' on its initial screen. This will sync your study data."
            }
        };

        // Global variables for app state
        let userData = {};
        let currentScreen = 'initialAuthScreen'; // Start with initial auth screen
        let subjects = [];
        let sessionTimerInterval = null;
        let currentSubjectStartTime = 0;
        let currentPauseStartTime = 0;
        let totalSessionStudyTime = 0;
        let totalSessionPauseTime = 0;
        let sessionSubjectsDurations = {};
        let currentSubject = '';
        let isStudying = false;
        let wakeLock = null;
        let pastSessions = [];
        let currentChart1 = null;
        let currentChart2 = null;
        let currentChart3 = null;
        let currentChart4 = null;

        // Firebase related variables (initialized in the module script)
        // These will be assigned from window.db, window.auth etc. after firebaseReady
        // No need to declare them here, as we'll use window.db directly.

        // DOM Elements
        const initialAuthScreen = document.getElementById('initialAuthScreen');
        const loginAnalIdButton = document.getElementById('loginAnalIdButton');
        const signupButton = document.getElementById('signupButton');

        const privacyPolicyScreen = document.getElementById('privacyPolicyScreen');
        const privacyAcceptCheckbox = document.getElementById('privacyAcceptCheckbox');
        const privacyContinueButton = document.getElementById('privacyContinueButton');

        const updateNotificationScreen = document.getElementById('updateNotificationScreen');
        const updateTitle = document.getElementById('updateTitle');
        const updateNotes = document.getElementById('updateNotes');
        const updateContinueButton = document.getElementById('updateContinueButton');

        const menuScreen = document.getElementById('menuScreen');
        const userNameInput = document.getElementById('userNameInput');
        const schoolNameInput = document.getElementById('schoolNameInput');
        const enterAppButton = document.getElementById('enterAppButton');

        const mainAppScreen = document.getElementById('mainAppScreen');
        const subjectsList = document.getElementById('subjectsList');
        const newSubjectInput = document.getElementById('newSubjectInput');
        const addSubjectButton = document.getElementById('addSubjectButton');
        const startStudyingButton = document.getElementById('startStudyingButton');
        const viewAllSessionsButton = document.getElementById('viewAllSessionsButton');
        const settingsButton = document.getElementById('settingsButton');

        const studySessionScreen = document.getElementById('studySessionScreen');
        const subjectSelect = document.getElementById('subjectSelect');
        const toggleStudyPauseButton = document.getElementById('toggleStudyPauseButton');
        const timerDisplay = document.getElementById('timerDisplay');
        const currentSubjectDisplay = document.getElementById('currentSubjectDisplay');
        const endSessionButton = document.getElementById('endSessionButton');
        const wakeLockMessage = document.getElementById('wakeLockMessage');
        const pauseInfoText = document.getElementById('pauseInfoText');

        const overviewScreen = document.getElementById('overviewScreen');
        const sessionSummaryText = document.getElementById('sessionSummaryText');
        const overviewSubjects = document.getElementById('overviewSubjects');
        const overviewTotalStudyTime = document.getElementById('overviewTotalStudyTime');
        const overviewTotalIdleTime = document.getElementById('overviewTotalIdleTime');
        const totalSessionDurationDisplay = document.getElementById('totalSessionDurationDisplay');
        const backToMainButton = document.getElementById('backToMainButton');

        const allSessionsOverviewScreen = document.getElementById('allSessionsOverviewScreen');
        const pastSessionsList = document.getElementById('pastSessionsList');
        const viewTotalOverviewButton = document.getElementById('viewTotalOverviewButton');
        const backToMainFromAllSessionsButton = document.getElementById('backToMainFromAllSessionsButton');

        const totalOverviewScreen = document.getElementById('totalOverviewScreen');
        const totalOverviewSummary = document.getElementById('totalOverviewSummary');
        const fromDateInput = document.getElementById('fromDateInput');
        const toDateInput = document.getElementById('toDateInput');
        const filterChartsButton = document.getElementById('filterChartsButton');
        const clearFilterButton = document.getElementById('clearFilterButton');
        const studyTimeTrendChartCanvas = document.getElementById('studyTimeTrendChart');
        const idleTimeTrendChartCanvas = document.getElementById('idleTimeTrendChart');
        const dailyStudyChartCanvas = document.getElementById('dailyStudyChart');
        const subjectsOverallChartCanvas = document.getElementById('subjectsOverallChart');
        const backToAllSessionsButton = document.getElementById('backToAllSessionsButton');

        const settingsScreen = document.getElementById('settingsScreen');
        const settingsUserNameInput = document.getElementById('settingsUserNameInput');
        const settingsSchoolNameInput = document.getElementById('settingsSchoolNameInput');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const pairDeviceButton = document.getElementById('pairDeviceButton'); // New button
        const viewPrivacyPolicyButton = document.getElementById('viewPrivacyPolicyButton');
        const patchNotesButton = document.getElementById('patchNotesButton');
        const helpButton = document.getElementById('helpButton');
        const backToMainFromSettingsButton = document.getElementById('backToMainFromSettingsButton');

        const patchNotesScreen = document.getElementById('patchNotesScreen');
        const patchNotesList = document.getElementById('patchNotesList');
        const backToSettingsFromPatchNotesButton = document.getElementById('backToSettingsFromPatchNotesButton');

        const helpScreen = document.getElementById('helpScreen');
        const backToSettingsFromHelpButton = document.getElementById('backToSettingsFromHelpButton');

        // Modals
        const renameModal = document.getElementById('renameModal');
        const newSessionNameInput = document.getElementById('newSessionNameInput');
        const cancelRenameButton = document.getElementById('cancelRenameButton');
        const confirmRenameButton = document.getElementById('confirmRenameButton');
        let sessionToRenameIndex = -1;

        const analIdInputModal = document.getElementById('analIdInputModal'); // New modal
        const analIdLoginInput = document.getElementById('analIdLoginInput');
        const cancelAnalIdLoginButton = document.getElementById('cancelAnalIdLoginButton');
        const submitAnalIdLoginButton = document.getElementById('submitAnalIdLoginButton');

        const analIdDisplayModal = document.getElementById('analIdDisplayModal'); // New modal
        const displayedAnalId = document.getElementById('displayedAnalId');
        const copyAnalIdButton = document.getElementById('copyAnalIdButton');
        const closeAnalIdDisplayButton = document.getElementById('closeAnalIdDisplayButton');

        const verificationModal = document.getElementById('verificationModal'); // New modal
        const verifyNameInput = document.getElementById('verifyNameInput');
        const verifySchoolInput = document.getElementById('verifySchoolInput');
        const cancelVerificationButton = document.getElementById('cancelVerificationButton');
        const submitVerificationButton = document.getElementById('submitVerificationButton');
        let userToVerify = null; // Store user data during verification

        const helpModal = document.getElementById('helpModal'); // Generic help modal for tooltips
        const helpModalTitle = document.getElementById('helpModalTitle');
        const helpModalContent = document.getElementById('helpModalContent');
        const closeHelpModalButton = document.getElementById('closeHelpModalButton');


        // Helper to show a modal
        function showModal(modalElement) {
            modalElement.style.display = 'flex';
        }

        // Helper to hide a modal
        function hideModal(modalElement) {
            modalElement.style.display = 'none';
        }

        // Function to show a temporary message box
        function showMessageBox(message, duration = 3000) {
            const messageBox = document.createElement('div');
            messageBox.className = 'message-box fixed bottom-4 left-1/2 -translate-x-1/2 z-50';
            messageBox.textContent = message;
            document.body.appendChild(messageBox);
            setTimeout(() => messageBox.remove(), duration);
        }

        // Function to switch screens
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
        }

        // --- Firebase Data Operations ---
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        async function getUserDocRef(uid) {
            if (!window.db) { // Explicitly use window.db
                console.error("Firestore not initialized.");
                return null;
            }
            return doc(window.db, `artifacts/${APP_ID}/users/${uid}`);
        }

        async function saveUserDataToFirestore() {
            if (!window.userId) { // Explicitly use window.userId
                console.error("User ID not available for saving data.");
                return;
            }
            const userDocRef = await getUserDocRef(window.userId); // Use window.userId
            if (!userDocRef) return;

            try {
                // Ensure data is stringified if it contains complex objects/arrays
                await setDoc(userDocRef, {
                    analId: window.userAnalId, // Save the Anal ID from window.userAnalId
                    name: userData.name,
                    school: userData.school,
                    privacyAccepted: userData.privacyAccepted,
                    lastUpdateVersion: userData.lastUpdateVersion,
                    subjects: JSON.stringify(subjects), // Store as JSON string
                    pastSessions: JSON.stringify(pastSessions) // Store as JSON string
                }, { merge: true }); // Use merge to avoid overwriting other fields
                console.log("User data saved to Firestore.");
            } catch (e) {
                console.error("Error saving user data to Firestore:", e);
                showMessageBox("Error saving data to cloud. Check console.");
            }
        }

        async function loadUserDataFromFirestore() {
            if (!window.userId) { // Explicitly use window.userId
                console.error("User ID not available for loading data.");
                return;
            }
            const userDocRef = await getUserDocRef(window.userId); // Use window.userId
            if (!userDocRef) return;

            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userData = {
                        name: data.name || '',
                        school: data.school || '',
                        privacyAccepted: data.privacyAccepted || false,
                        lastUpdateVersion: data.lastUpdateVersion || "0.0"
                    };
                    window.userAnalId = data.analId; // Load the Anal ID into window.userAnalId

                    // Parse data from JSON strings
                    subjects = data.subjects ? JSON.parse(data.subjects) : ['Maths', 'Science', 'History'];
                    pastSessions = data.pastSessions ? JSON.parse(data.pastSessions) : [];

                    userNameInput.value = userData.name;
                    schoolNameInput.value = userData.school;
                    settingsUserNameInput.value = userData.name;
                    settingsSchoolNameInput.value = userData.school;
                    console.log("User data loaded from Firestore.");
                } else {
                    console.log("No existing user data in Firestore for this user. Creating new profile.");
                    // If no data, initialize with defaults and save
                    userData = { privacyAccepted: false, lastUpdateVersion: "0.0", name: '', school: '' };
                    subjects = ['Maths', 'Science', 'History'];
                    pastSessions = [];
                    window.userAnalId = crypto.randomUUID(); // Generate a new Anal ID for new users
                    await saveUserDataToFirestore(); // Save initial data
                }
            } catch (e) {
                console.error("Error loading user data from Firestore:", e);
                showMessageBox("Error loading data from cloud. Check console.");
                // Fallback to default local data if Firestore fails
                userData = { privacyAccepted: false, lastUpdateVersion: "0.0", name: '', school: '' };
                subjects = ['Maths', 'Science', 'History'];
                pastSessions = [];
            }
        }

        // Function to save data (now primarily to Firestore)
        function saveDataWrapper() {
            saveUserDataToFirestore();
        }

        // --- Core App Logic (mostly unchanged, now uses Firebase data) ---

        // Render subjects list on Main App Screen
        function renderSubjects() {
            subjectsList.innerHTML = '';
            subjects.forEach(subject => {
                const subjectItem = document.createElement('div');
                subjectItem.className = 'subject-item';
                subjectItem.innerHTML = `
                    <span>${subject}</span>
                    <button class="delete-button" data-subject="${subject}">Remove</button>
                `;
                subjectsList.appendChild(subjectItem);
            });

            document.querySelectorAll('.delete-button').forEach(button => {
                button.onclick = (event) => {
                    const subjectToRemove = event.target.dataset.subject;
                    removeSubject(subjectToRemove);
                };
            });
        }

        // Add a new subject
        function addSubject() {
            const newSubject = newSubjectInput.value.trim();
            if (newSubject && !subjects.includes(newSubject)) {
                subjects.push(newSubject);
                newSubjectInput.value = '';
                saveDataWrapper();
                renderSubjects();
                populateSubjectSelect();
            }
        }

        // Remove a subject
        function removeSubject(subjectToRemove) {
            subjects = subjects.filter(subject => subject !== subjectToRemove);
            saveDataWrapper();
            renderSubjects();
            populateSubjectSelect();
        }

        // Populate subject dropdown for Study Session Screen
        function populateSubjectSelect() {
            subjectSelect.innerHTML = '';
            if (subjects.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No subjects available. Add some!';
                subjectSelect.appendChild(option);
                toggleStudyPauseButton.disabled = true;
                return;
            }
            toggleStudyPauseButton.disabled = false;
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
        }

        // Format time for display
        function formatTime(seconds) {
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        // Request Wake Lock to keep screen on
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLockMessage.style.display = 'block';
                    wakeLock.addEventListener('release', () => {
                        wakeLockMessage.style.display = 'none';
                    });
                } catch (err) {
                    wakeLockMessage.textContent = 'Screen might turn off during study. Grant permission for screen stay-on.';
                    wakeLockMessage.style.display = 'block';
                }
            } else {
                wakeLockMessage.textContent = 'Wake Lock API not supported by your browser. Screen might turn off.';
                wakeLockMessage.style.display = 'block';
            }
        }

        // Release Wake Lock
        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
                wakeLockMessage.style.display = 'none';
            }
        }

        // Function to update the timer display and accumulate study time
        function updateTimerDisplay() {
            const elapsed = Math.floor((Date.now() - currentSubjectStartTime) / 1000);
            timerDisplay.textContent = formatTime(elapsed);
        }

        // Toggle Study/Pause functionality
        function toggleStudyPause() {
            if (!isStudying) { // Currently paused or fresh start, so start/resume study
                currentSubject = subjectSelect.value;
                if (!currentSubject) {
                    showMessageBox('Please select a subject to start studying.');
                    return;
                }

                // If resuming from a pause, calculate and add to totalSessionPauseTime
                if (currentPauseStartTime !== 0) {
                    totalSessionPauseTime += Math.floor((Date.now() - currentPauseStartTime) / 1000);
                    currentPauseStartTime = 0; // Reset pause start time
                }

                isStudying = true;
                currentSubjectStartTime = Date.now(); // Start new study segment
                
                // Initialize subject duration if not present
                if (!sessionSubjectsDurations[currentSubject]) {
                    sessionSubjectsDurations[currentSubject] = 0;
                }

                clearInterval(sessionTimerInterval); // Clear any existing interval
                sessionTimerInterval = setInterval(() => {
                    sessionSubjectsDurations[currentSubject] += 1; // Accumulate per subject
                    updateTimerDisplay(); // Update current segment timer
                }, 1000);

                requestWakeLock();
                toggleStudyPauseButton.textContent = "Pause Study";
                subjectSelect.disabled = true; // Disable subject selection while studying
                currentSubjectDisplay.textContent = `Studying: ${currentSubject}`;

            } else { // Currently studying, user wants to pause
                isStudying = false;
                clearInterval(sessionTimerInterval); // Stop study timer

                // Add time from the just-ended study segment to total study time
                totalSessionStudyTime += Math.floor((Date.now() - currentSubjectStartTime) / 1000);
                
                currentPauseStartTime = Date.now(); // Start tracking pause time
                releaseWakeLock();
                toggleStudyPauseButton.textContent = "Resume Study";
                currentSubjectDisplay.textContent = 'Paused';
                subjectSelect.disabled = false; // Enable subject selection when paused
            }
        }

        // End the entire study session
        function endSession() {
            clearInterval(sessionTimerInterval); // Stop any active study timer

            // If still studying, add remaining time to total study and subject duration
            if (isStudying) {
                totalSessionStudyTime += Math.floor((Date.now() - currentSubjectStartTime) / 1000);
                sessionSubjectsDurations[currentSubject] += Math.floor((Date.now() - currentSubjectStartTime) / 1000);
            }
            // If paused, add remaining time to total pause duration
            if (!isStudying && currentPauseStartTime !== 0) {
                totalSessionPauseTime += Math.floor((Date.now() - currentPauseStartTime) / 1000);
            }

            releaseWakeLock();

            // Prepare session data for saving
            const sessionData = {
                id: Date.now(), // Unique ID for the session
                name: `Session on ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`, // Default name
                date: new Date().toISOString(),
                totalStudyDuration: totalSessionStudyTime,
                totalPauseDuration: totalSessionPauseTime,
                subjectsStudied: { ...sessionSubjectsDurations }
            };
            pastSessions.push(sessionData);
            saveDataWrapper(); // Save updated pastSessions to Firestore

            renderOverview(); // Render current session overview
            showScreen('overviewScreen');

            // Reset session data for next study
            totalSessionStudyTime = 0;
            totalSessionPauseTime = 0;
            sessionSubjectsDurations = {};
            currentSubject = '';
            currentSubjectStartTime = 0;
            currentPauseStartTime = 0;
            isStudying = false;
            
            timerDisplay.textContent = '00:00:00';
            currentSubjectDisplay.textContent = '';
            toggleStudyPauseButton.textContent = 'Start Timer'; // Reset button text
            subjectSelect.disabled = false;
        }

        // Render current session overview
        function renderOverview() {
            overviewSubjects.innerHTML = '';
            let maxDuration = 0;
            for (const subject in sessionSubjectsDurations) {
                if (sessionSubjectsDurations[subject] > maxDuration) {
                    maxDuration = sessionSubjectsDurations[subject];
                }
            }

            let mostStudiedSubject = '';
            let maxSubjectDuration = 0;
            for (const subject in sessionSubjectsDurations) {
                if (sessionSubjectsDurations[subject] > maxSubjectDuration) {
                    maxSubjectDuration = sessionSubjectsDurations[subject];
                    mostStudiedSubject = subject;
                }
            }

            let summaryText = '';
            if (Object.keys(sessionSubjectsDurations).length > 0) {
                summaryText = `Great job! You focused most on ${mostStudiedSubject} today.`;
            } else {
                summaryText = 'No subjects were actively studied in this session.';
            }
            sessionSummaryText.textContent = summaryText;

            if (Object.keys(sessionSubjectsDurations).length === 0) {
                overviewSubjects.innerHTML = '<p class="text-center text-gray-400">No subjects recorded for this session.</p>';
            } else {
                for (const subject in sessionSubjectsDurations) {
                    const duration = sessionSubjectsDurations[subject];
                    const percentage = maxDuration > 0 ? (duration / maxDuration) * 100 : 0;

                    const subjectOverviewItem = document.createElement('div');
                    subjectOverviewItem.className = 'bg-gray-700 p-3 rounded-xl mb-2';
                    subjectOverviewItem.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold">${subject}</span>
                            <span class="text-sm text-blue-300">${formatTime(duration)}</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${percentage}%;"></div>
                        </div>
                    `;
                    overviewSubjects.appendChild(subjectOverviewItem);
                }
            }
            
            overviewTotalStudyTime.textContent = `Active Study Time: ${formatTime(totalSessionStudyTime)}`;
            overviewTotalIdleTime.textContent = `Idle/Paused Time: ${formatTime(totalSessionPauseTime)}`;
            totalSessionDurationDisplay.textContent = formatTime(totalSessionStudyTime + totalSessionPauseTime);
        }

        // Function to open the rename modal
        function openRenameModal(sessionId) {
            sessionToRenameIndex = pastSessions.findIndex(session => session.id === sessionId);
            if (sessionToRenameIndex !== -1) {
                newSessionNameInput.value = pastSessions[sessionToRenameIndex].name;
                showModal(renameModal);
            }
        }

        // Function to rename a session
        function renameSession() {
            if (sessionToRenameIndex !== -1) {
                const newName = newSessionNameInput.value.trim();
                if (newName) {
                    pastSessions[sessionToRenameIndex].name = newName;
                    saveDataWrapper();
                    renderAllSessionsOverview(); // Re-render the list to show the new name
                    hideModal(renameModal);
                    sessionToRenameIndex = -1; // Reset
                } else {
                    showMessageBox('Session name cannot be empty.', 3000);
                }
            }
        }

        // Function to delete a session
        function deleteSession(sessionId) {
            const confirmDeleteModal = document.createElement('div');
            confirmDeleteModal.id = 'confirmDeleteModal';
            confirmDeleteModal.className = 'modal'; // Use modal class
            confirmDeleteModal.innerHTML = `
                <div class="modal-content">
                    <h2 class="text-xl font-bold mb-4">Confirm Delete</h2>
                    <p class="text-gray-300 mb-4">Are you sure you want to delete this session? This action cannot be undone.</p>
                    <div class="button-group">
                        <button id="cancelDeleteButton" class="bg-gray-600 hover:bg-gray-700">Cancel</button>
                        <button id="confirmDeleteButton" class="bg-red-500 hover:bg-red-600">Delete</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDeleteModal);
            showModal(confirmDeleteModal); // Show the modal

            document.getElementById('cancelDeleteButton').onclick = () => {
                hideModal(confirmDeleteModal);
                confirmDeleteModal.remove();
            };

            document.getElementById('confirmDeleteButton').onclick = () => {
                pastSessions = pastSessions.filter(session => session.id !== sessionId);
                saveDataWrapper();
                renderAllSessionsOverview(); // Re-render the list
                hideModal(confirmDeleteModal);
                confirmDeleteModal.remove();
            };
        }

        // Render all past sessions overview
        function renderAllSessionsOverview() {
            pastSessionsList.innerHTML = '';
            if (pastSessions.length === 0) {
                pastSessionsList.innerHTML = '<p class="text-center text-gray-400">No past sessions recorded yet.</p>';
                return;
            }

            const sortedSessions = [...pastSessions].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedSessions.forEach((session) => {
                const sessionDate = new Date(session.date).toLocaleString();
                const subjectsSummary = Object.keys(session.subjectsStudied).join(', ') || 'None';
                const totalStudyFormatted = formatTime(session.totalStudyDuration);
                const totalPauseFormatted = formatTime(session.totalPauseDuration);
                const totalSessionOverallDuration = formatTime(session.totalStudyDuration + session.totalPauseDuration);

                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-card';
                sessionItem.innerHTML = `
                    <h3>
                        <span class="font-semibold text-blue-300">${session.name}</span>
                        <button class="edit-button" data-session-id="${session.id}">Edit Name</button>
                        <button class="delete-button" data-session-id="${session.id}">Delete</button>
                    </h3>
                    <p class="text-sm text-gray-300 mb-1">Date: ${sessionDate}</p>
                    <p class="text-sm text-gray-300 mb-1">Studied: ${subjectsSummary}</p>
                    <p class="text-sm text-gray-300 mb-1">Active Study Time: <span class="font-medium">${totalStudyFormatted}</span></p>
                    <p class="text-sm text-gray-300 mb-1">Idle/Paused Time: <span class="font-medium">${totalPauseFormatted}</span></p>
                    <p class="text-sm text-gray-300">Total Session Duration: <span class="font-medium">${totalSessionOverallDuration}</span></p>
                `;
                pastSessionsList.appendChild(sessionItem);
            });

            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-button').forEach(button => {
                button.onclick = (event) => {
                    const sessionId = parseInt(event.target.dataset.sessionId);
                    openRenameModal(sessionId);
                };
            });
            document.querySelectorAll('.delete-button').forEach(button => {
                button.onclick = (event) => {
                    const sessionId = parseInt(event.target.dataset.sessionId);
                    deleteSession(sessionId);
                };
            });
        }

        // Render total overview analytics
        function renderTotalOverview() {
            let filteredSessions = pastSessions;

            const fromDate = fromDateInput.value ? new Date(fromDateInput.value) : null;
            const toDate = toDateInput.value ? new Date(toDateInput.value) : null;

            if (fromDate || toDate) {
                filteredSessions = pastSessions.filter(session => {
                    const sessionDate = new Date(session.date);
                    const sessionDateOnly = new Date(sessionDate.getFullYear(), sessionDate.getMonth(), sessionDate.getDate()); // Ignore time for comparison
                    
                    let isAfterFrom = true;
                    if (fromDate) {
                        const fromDateOnly = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
                        isAfterFrom = sessionDateOnly >= fromDateOnly;
                    }

                    let isBeforeTo = true;
                    if (toDate) {
                        const toDateOnly = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate());
                        isBeforeTo = sessionDateOnly <= toDateOnly;
                    }
                    return isAfterFrom && isBeforeTo;
                });
            }

            let overallTotalStudy = 0;
            let overallTotalPause = 0;
            let overallSubjectsData = {}; // {subject: totalDuration}
            const sessionLabels = []; // Use session names for labels
            const sessionStudyDurations = [];
            const sessionIdleDurations = [];
            const dailyStudyData = {}; // { 'YYYY-MM-DD': totalSeconds }

            filteredSessions.forEach(session => {
                overallTotalStudy += session.totalStudyDuration;
                overallTotalPause += session.totalPauseDuration;
                
                sessionLabels.push(session.name || new Date(session.date).toLocaleDateString());
                sessionStudyDurations.push(session.totalStudyDuration / 60); // Convert to minutes for chart
                sessionIdleDurations.push(session.totalPauseDuration / 60); // Convert to minutes for chart

                const sessionDateKey = new Date(session.date).toISOString().split('T')[0]; // YYYY-MM-DD
                if (dailyStudyData[sessionDateKey]) {
                    dailyStudyData[sessionDateKey] += session.totalStudyDuration;
                } else {
                    dailyStudyData[sessionDateKey] = session.totalStudyDuration;
                }

                for (const subject in session.subjectsStudied) {
                    if (overallSubjectsData[subject]) {
                        overallSubjectsData[subject] += session.subjectsStudied[subject];
                    } else {
                        overallSubjectsData[subject] = session.subjectsStudied[subject];
                    }
                }
            });

            const totalSessionsCount = filteredSessions.length;
            const avgStudyPerSession = totalSessionsCount > 0 ? overallTotalStudy / totalSessionsCount : 0;

            totalOverviewSummary.textContent = `You've completed ${totalSessionsCount} sessions (filtered), with a total active study time of ${formatTime(overallTotalStudy)} and total idle time of ${formatTime(overallTotalPause)}. Your average active study time per session is ${formatTime(avgStudyPerSession)}.`;

            // Destroy existing charts if they exist
            if (currentChart1) currentChart1.destroy();
            if (currentChart2) currentChart2.destroy();
            if (currentChart3) currentChart3.destroy();
            if (currentChart4) currentChart4.destroy();

            // Chart 1: Study Time Trend per Session
            const ctx1 = studyTimeTrendChartCanvas.getContext('2d');
            currentChart1 = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: sessionLabels,
                    datasets: [{
                        label: 'Active Study Time (minutes)',
                        data: sessionStudyDurations.map(d => Math.round(d)),
                        borderColor: '#63b3ed',
                        backgroundColor: 'rgba(99, 179, 237, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Minutes', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' },
                            grid: { color: '#4a5568' }
                        },
                        x: {
                            title: { display: true, text: 'Session Name / Date', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' },
                            grid: { color: '#4a5568' }
                        }
                    },
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });

            // Chart 3: Idle Time Trend (per session)
            const ctx3 = idleTimeTrendChartCanvas.getContext('2d');
            currentChart3 = new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: sessionLabels,
                    datasets: [{
                        label: 'Idle/Paused Time (minutes)',
                        data: sessionIdleDurations.map(d => Math.round(d)),
                        borderColor: '#6b7280', // Grey color for idle
                        backgroundColor: 'rgba(107, 114, 128, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Minutes', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' },
                            grid: { color: '#4a5568' }
                        },
                        x: {
                            title: { display: true, text: 'Session Name / Date', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' },
                            grid: { color: '#4a5568' }
                        }
                    },
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });

            // Chart 4: Daily Study Time (Bar Chart)
            const dailyLabels = Object.keys(dailyStudyData).sort();
            const dailyDurations = dailyLabels.map(date => Math.round(dailyStudyData[date] / 60)); // Convert to minutes

            const ctx4 = dailyStudyChartCanvas.getContext('2d');
            currentChart4 = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Daily Active Study Time (minutes)',
                        data: dailyDurations,
                        backgroundColor: 'rgba(72, 187, 120, 0.7)', // Green for daily study
                        borderColor: '#48bb78',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Minutes', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' },
                            grid: { color: '#4a5568' }
                        },
                        x: {
                            title: { display: true, text: 'Date', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' },
                            grid: { color: '#4a5568' }
                        }
                    },
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });


            // Chart 2: Top Subjects Studied Overall (using filtered data)
            const subjectLabels = Object.keys(overallSubjectsData);
            const subjectDurations = Object.values(overallSubjectsData).map(d => Math.round(d / 60)); // Convert to minutes

            const ctx2 = subjectsOverallChartCanvas.getContext('2d');
            currentChart2 = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: subjectLabels,
                    datasets: [{
                        label: 'Total Time Studied (minutes)',
                        data: subjectDurations,
                        backgroundColor: [
                            'rgba(99, 179, 237, 0.7)', // Blue
                            'rgba(72, 187, 120, 0.7)', // Green
                            'rgba(246, 173, 85, 0.7)',  // Orange
                            'rgba(237, 100, 166, 0.7)', // Pink
                            'rgba(159, 122, 233, 0.7)', // Purple
                            'rgba(56, 178, 172, 0.7)'  // Teal
                        ],
                        borderColor: [
                            '#63b3ed',
                            '#48bb78',
                            '#f6ad55',
                            '#ed64a6',
                            '#9f7aea',
                            '#38b2ac'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Minutes', color: '#e2e8f0' },
                            ticks: { color: '#e2e8f0' },
                            grid: { color: '#4a5568' }
                        },
                        x: {
                            ticks: { color: '#e2e8f0' },
                            grid: { color: '#4a5568' }
                        }
                    },
                    plugins: { legend: { labels: { color: '#e2e8f0' } } }
                }
            });
        }

        // --- Authentication/Flow Management ---

        // Function to proceed after initial Firebase auth (called by firebaseReady event)
        async function proceedAfterFirebaseReady() {
            userId = window.auth.currentUser?.uid; // Ensure userId is set from Firebase Auth
            console.log("Proceeding with app initialization for Firebase User ID:", userId);

            await loadUserDataFromFirestore(); // Load user data from Firestore

            // Determine which screen to show first based on user data
            if (!userData.privacyAccepted) {
                showScreen('privacyPolicyScreen');
            } else if (userData.lastUpdateVersion < currentAppVersion) {
                renderUpdateNotification();
                showScreen('updateNotificationScreen');
            } else if (userData.name) { // User has name, implies they've gone through signup/login
                showScreen('mainAppScreen');
                renderSubjects();
                populateSubjectSelect();
            } else { // User is authenticated but no name, implies new signup
                showScreen('menuScreen'); // Go to name/school input
            }
        }

        // --- Event Listeners ---

        // Initial Auth Screen
        loginAnalIdButton.onclick = () => {
            showModal(analIdInputModal);
            analIdLoginInput.value = ''; // Clear previous input
        };

        signupButton.onclick = async () => {
            // For signup, we just move to the menu screen to get name/school.
            // A new Anal ID will be generated and saved when they click "Enter App".
            showScreen('menuScreen');
        };

        // Privacy Policy Screen
        privacyAcceptCheckbox.onchange = () => {
            privacyContinueButton.disabled = !privacyAcceptCheckbox.checked;
        };

        privacyContinueButton.onclick = () => {
            userData.privacyAccepted = true;
            saveDataWrapper(); // Save acceptance to Firestore
            // After accepting privacy, check for updates
            if (userData.lastUpdateVersion < currentAppVersion) {
                renderUpdateNotification();
                showScreen('updateNotificationScreen');
            } else if (userData.name) {
                showScreen('mainAppScreen');
                renderSubjects();
                populateSubjectSelect();
            } else {
                showScreen('menuScreen');
            }
        };

        // Update Notification Screen
        updateContinueButton.onclick = () => {
            userData.lastUpdateVersion = currentAppVersion; // Mark update as seen
            saveDataWrapper(); // Save update version to Firestore
            if (userData.name) {
                showScreen('mainAppScreen');
                renderSubjects();
                populateSubjectSelect();
            } else {
                showScreen('menuScreen');
            }
        };

        // Menu Screen (for initial signup)
        enterAppButton.onclick = async () => {
            // For new signups, ensure userAnalId is set and save data
            if (!userAnalId) {
                userAnalId = crypto.randomUUID(); // Generate Anal ID for new signup
            }
            userData.name = userNameInput.value.trim();
            userData.school = schoolNameInput.value.trim();
            await saveDataWrapper(); // Save initial user data including Anal ID

            // After initial data is set, proceed to privacy policy
            if (!userData.privacyAccepted) {
                showScreen('privacyPolicyScreen');
            } else if (userData.lastUpdateVersion < currentAppVersion) {
                renderUpdateNotification();
                showScreen('updateNotificationScreen');
            } else {
                showScreen('mainAppScreen');
                renderSubjects();
                populateSubjectSelect();
            }
        };

        // Main App Screen
        addSubjectButton.onclick = addSubject;
        newSubjectInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addSubject();
            }
        });

        startStudyingButton.onclick = () => {
            showScreen('studySessionScreen');
            populateSubjectSelect();
            timerDisplay.textContent = '00:00:00';
            currentSubjectDisplay.textContent = '';
            toggleStudyPauseButton.textContent = 'Start Timer';
            subjectSelect.disabled = false;
        };

        viewAllSessionsButton.onclick = () => {
            renderAllSessionsOverview();
            showScreen('allSessionsOverviewScreen');
        };

        settingsButton.onclick = () => {
            settingsUserNameInput.value = userData.name || '';
            settingsSchoolNameInput.value = userData.school || '';
            showScreen('settingsScreen');
        };

        // Settings Screen
        saveSettingsButton.onclick = async () => {
            userData.name = settingsUserNameInput.value.trim();
            userData.school = settingsSchoolNameInput.value.trim();
            await saveDataWrapper(); // Save updated user data to Firestore
            showMessageBox("Settings saved!");
            showScreen('mainAppScreen');
        };

        pairDeviceButton.onclick = () => { // Display Anal ID for pairing
            displayedAnalId.textContent = userAnalId || "ID not available. Please sign up first.";
            showModal(analIdDisplayModal);
        };

        viewPrivacyPolicyButton.onclick = () => {
            showScreen('privacyPolicyScreen');
            privacyAcceptCheckbox.checked = userData.privacyAccepted || false;
            privacyContinueButton.disabled = !privacyAcceptCheckbox.checked;
        };

        patchNotesButton.onclick = () => {
            renderPatchNotes();
            showScreen('patchNotesScreen');
        };

        helpButton.onclick = () => {
            showScreen('helpScreen');
        };

        backToMainFromSettingsButton.onclick = () => {
            showScreen('mainAppScreen');
        };

        // Patch Notes Screen
        backToSettingsFromPatchNotesButton.onclick = () => {
            showScreen('settingsScreen');
        };

        // Help Screen
        backToSettingsFromHelpButton.onclick = () => {
            showScreen('settingsScreen');
        };

        // Study Session Screen
        toggleStudyPauseButton.onclick = toggleStudyPause;
        endSessionButton.onclick = endSession;

        // Session Overview Screen
        backToMainButton.onclick = () => {
            showScreen('mainAppScreen');
            renderSubjects();
            populateSubjectSelect();
        };

        // All Sessions Overview Screen
        backToMainFromAllSessionsButton.onclick = () => {
            showScreen('mainAppScreen');
        };

        viewTotalOverviewButton.onclick = () => {
            renderTotalOverview();
            showScreen('totalOverviewScreen');
        };

        // Total Overview Screen
        filterChartsButton.onclick = () => {
            renderTotalOverview();
        };

        clearFilterButton.onclick = () => {
            fromDateInput.value = '';
            toDateInput.value = '';
            renderTotalOverview();
        };

        backToAllSessionsButton.onclick = () => {
            showScreen('allSessionsOverviewScreen');
            renderAllSessionsOverview();
        };

        // Modals Event Listeners
        // Rename Session Modal
        cancelRenameButton.onclick = () => {
            hideModal(renameModal);
            sessionToRenameIndex = -1;
        };
        confirmRenameButton.onclick = renameSession;
        newSessionNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                renameSession();
            }
        });

        // Anal ID Input Modal
        cancelAnalIdLoginButton.onclick = () => {
            hideModal(analIdInputModal);
            showScreen('initialAuthScreen'); // Go back to initial auth screen
        };
        submitAnalIdLoginButton.onclick = async () => {
            const enteredAnalId = analIdLoginInput.value.trim();
            if (!enteredAnalId) {
                showMessageBox("Please enter an Anal ID.");
                return;
            }

            try {
                // Query Firestore to find the user with this Anal ID
                const usersRef = collection(window.db, `artifacts/${APP_ID}/users`); // Use window.db
                const q = query(usersRef, where("analId", "==", enteredAnalId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showMessageBox("Anal ID not found. Please check and try again.");
                    return;
                }

                // Assuming Anal ID is unique, get the first matching user
                userToVerify = querySnapshot.docs[0].data();
                userToVerify.docId = querySnapshot.docs[0].id; // Store Firestore document ID

                hideModal(analIdInputModal);
                showModal(verificationModal);
                verifyNameInput.value = ''; // Clear inputs
                verifySchoolInput.value = '';
            } catch (error) {
                console.error("Error searching for Anal ID:", error);
                showMessageBox("Error logging in. Please try again.");
            }
        };

        // Anal ID Display Modal
        copyAnalIdButton.onclick = () => {
            const idText = displayedAnalId.textContent;
            if (idText) {
                // Use a temporary textarea for copying to clipboard
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = idText;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextArea);
                showMessageBox("Anal ID copied to clipboard!");
            }
        };
        closeAnalIdDisplayButton.onclick = () => {
            hideModal(analIdDisplayModal);
        };

        // Verification Modal
        cancelVerificationButton.onclick = () => {
            hideModal(verificationModal);
            showScreen('initialAuthScreen'); // Go back to initial auth screen
            userToVerify = null;
        };
        submitVerificationButton.onclick = async () => {
            if (!userToVerify) {
                showMessageBox("No user data to verify. Please try logging in again.");
                return;
            }

            const enteredName = verifyNameInput.value.trim();
            const enteredSchool = verifySchoolInput.value.trim();

            // Simple verification: name must match, school is optional but if provided, must match
            if (enteredName === userToVerify.name &&
                (userToVerify.school === '' || enteredSchool === userToVerify.school)) {
                
                // For this simulation, we'll just load the verified user's data
                // In a real app, you'd perform Firebase re-authentication or custom token sign-in here
                // to link the current Firebase Auth user to the target user's data.
                
                // Set the current userId and userAnalId to the verified user's data
                window.userId = userToVerify.docId; 
                window.userAnalId = userToVerify.analId; 

                // Load the verified user's data
                await loadUserDataFromFirestore();
                hideModal(verificationModal);
                showMessageBox("Login successful!");

                // Proceed to Privacy Policy -> Update Notification -> Main App
                if (!userData.privacyAccepted) {
                    showScreen('privacyPolicyScreen');
                } else if (userData.lastUpdateVersion < currentAppVersion) {
                    renderUpdateNotification();
                    showScreen('updateNotificationScreen');
                } else {
                    showScreen('mainAppScreen');
                    renderSubjects();
                    populateSubjectSelect();
                }

            } else {
                showMessageBox("Verification failed. Name or School does not match.");
            }
        };

        // Help Icon Click Handler
        document.querySelectorAll('.help-icon').forEach(icon => {
            icon.onclick = (event) => {
                const helpKey = event.target.dataset.help;
                const content = helpContent[helpKey];
                if (content) {
                    helpModalTitle.textContent = content.title;
                    helpModalContent.textContent = content.content;
                    showModal(helpModal);
                }
            };
        });

        closeHelpModalButton.onclick = () => {
            hideModal(helpModal);
        };

        // Function to render the latest update notification
        function renderUpdateNotification() {
            const latestUpdate = patchNotesData[patchNotesData.length - 1];
            updateTitle.textContent = `${latestUpdate.title} (v${latestUpdate.version})`;
            updateNotes.innerHTML = '';
            latestUpdate.notes.forEach(note => {
                const li = document.createElement('li');
                li.textContent = `-> ${note}`;
                updateNotes.appendChild(li);
            });
        }

        // Function to render all patch notes
        function renderPatchNotes() {
            patchNotesList.innerHTML = '';
            patchNotesData.forEach(patch => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${patch.title} (v${patch.version}):</strong>`;
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside ml-4 mt-1 mb-2';
                patch.notes.forEach(note => {
                    const noteLi = document.createElement('li');
                    noteLi.textContent = note;
                    ul.appendChild(noteLi);
                });
                li.appendChild(ul);
                patchNotesList.appendChild(li);
            });
        }

        // Initialize the app on page load
        // This will now wait for the 'firebaseReady' event to be dispatched
        // by the Firebase module script.
        window.addEventListener('firebaseReady', proceedAfterFirebaseReady);
    </script>
</body>
</html>
